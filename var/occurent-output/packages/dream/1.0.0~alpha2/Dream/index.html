<div><h2 id="types"><a href="#types" class="anchor"></a>Types</h2><p>Dream is built on just five types. The first two are the data types of Dream. Both are abstract, even though they appear to have definitions:</p><div class="odoc-spec"><div class="spec type" id="type-request" class="anchored"><a href="#type-request" class="anchor"></a><code><span><span class="keyword">type</span> request</span><span> = <span><a href="#type-incoming">incoming</a> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>HTTP requests, such as <code>GET /something HTTP/1.1</code>. See <a href="#requests">Requests</a>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-response" class="anchored"><a href="#type-response" class="anchor"></a><code><span><span class="keyword">and</span> response</span><span> = <span><a href="#type-outgoing">outgoing</a> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>HTTP responses, such as <code>200 OK</code>. See <a href="#responses">Responses</a>.</p></div></div><p>The remaining three types are for building up Web apps.</p><div class="odoc-spec"><div class="spec type" id="type-handler" class="anchored"><a href="#type-handler" class="anchor"></a><code><span><span class="keyword">and</span> handler</span><span> = <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Handlers are asynchronous functions from requests to responses. Example <a href="https://github.com/aantron/dream/tree/master/example/1-hello#files"><code>1-hello</code></a> [<a href="http://dream.as/1-hello">playground</a>] shows the simplest handler, an anonymous function which we pass to <a href="#val-run"><code>Dream.run</code></a>. This creates a complete Web server! You can also see the Reason version in example <a href="https://github.com/aantron/dream/tree/master/example/r-hello#files"><code>r-hello</code></a>.</p><pre><code>let () =
  Dream.run (fun _ -&gt;
    Dream.html &quot;Good morning, world!&quot;)</code></pre></div></div><div class="odoc-spec"><div class="spec type" id="type-middleware" class="anchored"><a href="#type-middleware" class="anchor"></a><code><span><span class="keyword">and</span> middleware</span><span> = <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Middlewares are functions that take a <a href="#type-handler"><code>handler</code></a>, and run some code before or after — producing a “bigger” handler. Example <a href="https://github.com/aantron/dream/tree/master/example/2-middleware#files"><code>2-middleware</code></a> inserts the <a href="#val-logger"><code>Dream.logger</code></a> middleware into a Web app:</p><pre><code>let () =
  Dream.run
  @@ Dream.logger
  @@ fun _ -&gt; Dream.html &quot;Good morning, world!&quot;</code></pre><p>Examples <a href="https://github.com/aantron/dream/tree/master/example/4-counter#files"><code>4-counter</code></a> [<a href="http://dream.as/4-counter">playground</a>] and <a href="https://github.com/aantron/dream/tree/master/example/5-promise#files"><code>5-promise</code></a> show user-defined middlewares:</p><pre><code>let count_requests inner_handler request =
  count := !count + 1;
  inner_handler request</code></pre><p>In case you are wondering why the example middleware <code>count_requests</code> takes two arguments, while the type says it should take only one, it's because:</p><pre><code>middleware
  = handler -&gt; handler
  = handler -&gt; (request -&gt; response promise)
  = handler -&gt; request -&gt; response promise</code></pre></div></div><div class="odoc-spec"><div class="spec type" id="type-route" class="anchored"><a href="#type-route" class="anchor"></a><code><span><span class="keyword">and</span> route</span></code></div><div class="spec-doc"><p>Routes tell <a href="#val-router"><code>Dream.router</code></a> which handler to select for each request. See <a href="#routing">Routing</a> and example <a href="https://github.com/aantron/dream/tree/master/example/3-router#files"><code>3-router</code></a> [<a href="http://dream.as/3-router/echo/foo">playground</a>]. Routes are created by helpers such as <a href="#val-get"><code>Dream.get</code></a> and <a href="#val-scope"><code>Dream.scope</code></a>:</p><pre><code>Dream.router [
  Dream.scope &quot;/admin&quot; [Dream.memory_sessions] [
    Dream.get &quot;/&quot; admin_handler;
    Dream.get &quot;/logout&quot; admin_logout_handler;
  ];
]</code></pre></div></div><h3 id="algebra"><a href="#algebra" class="anchor"></a>Algebra</h3><p>The three handler-related types have a vaguely algebraic interpretation:</p><ul><li>Each literal <a href="#type-handler"><code>handler</code></a> is an atom.</li><li><a href="#type-middleware"><code>middleware</code></a> is for sequential composition (product-like). <a href="#val-no_middleware"><code>Dream.no_middleware</code></a> is <b>1</b>.</li><li><a href="#type-route"><code>route</code></a> is for alternative composition (sum-like). <a href="#val-no_route"><code>Dream.no_route</code></a> is <b>0</b>.</li></ul><p><a href="#val-scope"><code>Dream.scope</code></a> implements a left distributive law, making Dream a ring-like structure.</p><h3 id="helpers"><a href="#helpers" class="anchor"></a>Helpers</h3><div class="odoc-spec"><div class="spec type" id="type-message" class="anchored"><a href="#type-message" class="anchor"></a><code><span><span class="keyword">and</span> <span>'a message</span></span></code></div><div class="spec-doc"><p><code>'a message</code>, pronounced “any message,” allows some functions to take either <a href="#type-request"><code>request</code></a> or <a href="#type-response"><code>response</code></a> as arguments, because both are defined in terms of <code>'a message</code>. For example, in <a href="#headers">Headers</a>:</p><pre><code>val Dream.header : string -&gt; 'a message -&gt; string option</code></pre></div></div><div class="odoc-spec"><div class="spec type" id="type-incoming" class="anchored"><a href="#type-incoming" class="anchor"></a><code><span><span class="keyword">and</span> incoming</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-outgoing" class="anchored"><a href="#type-outgoing" class="anchor"></a><code><span><span class="keyword">and</span> outgoing</span></code></div><div class="spec-doc"><p>Type parameters for <a href="#type-message"><code>message</code></a> for <a href="#type-request"><code>request</code></a> and <a href="#type-response"><code>response</code></a>, respectively. These are “phantom” types. They have no meaning other than they are different from each other. Dream only ever creates <code>incoming
    message</code> and <code>outgoing message</code>. <code>incoming</code> and <code>outgoing</code> are never mentioned again in the docs.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-promise" class="anchored"><a href="#type-promise" class="anchor"></a><code><span><span class="keyword">and</span> <span>'a promise</span></span><span> = <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Dream uses <a href="https://github.com/ocsigen/lwt">Lwt</a> for promises and asynchronous I/O. See example <a href="https://github.com/aantron/dream/tree/master/example/5-promise#files"><code>5-promise</code></a> [<a href="http://dream.as/5-promise">playground</a>].</p><p>Use <code>raise</code> to reject promises. If you are writing a library, you may prefer using <a href="https://github.com/ocsigen/lwt/blob/9943ba77a5508feaea5e1fb60b011db4179f9c61/src/core/lwt.mli#L459"><code>Lwt.fail</code></a> in some places, in order to avoid clobbering your user's current exception backtrace — though, in most cases, you should still extend it with <code>raise</code> and <code>let%lwt</code>, instead.</p></div></div><h2 id="methods"><a href="#methods" class="anchor"></a>Methods</h2><div class="odoc-spec"><div class="spec type" id="type-method_" class="anchored"><a href="#type-method_" class="anchor"></a><code><span><span class="keyword">type</span> method_</span><span> = </span><span>[ </span></code><table><tr id="type-method_.GET" class="anchored"><td class="def constructor"><a href="#type-method_.GET" class="anchor"></a><code><span>| </span></code><code><span>`GET</span></code></td></tr><tr id="type-method_.POST" class="anchored"><td class="def constructor"><a href="#type-method_.POST" class="anchor"></a><code><span>| </span></code><code><span>`POST</span></code></td></tr><tr id="type-method_.PUT" class="anchored"><td class="def constructor"><a href="#type-method_.PUT" class="anchor"></a><code><span>| </span></code><code><span>`PUT</span></code></td></tr><tr id="type-method_.DELETE" class="anchored"><td class="def constructor"><a href="#type-method_.DELETE" class="anchor"></a><code><span>| </span></code><code><span>`DELETE</span></code></td></tr><tr id="type-method_.HEAD" class="anchored"><td class="def constructor"><a href="#type-method_.HEAD" class="anchor"></a><code><span>| </span></code><code><span>`HEAD</span></code></td></tr><tr id="type-method_.CONNECT" class="anchored"><td class="def constructor"><a href="#type-method_.CONNECT" class="anchor"></a><code><span>| </span></code><code><span>`CONNECT</span></code></td></tr><tr id="type-method_.OPTIONS" class="anchored"><td class="def constructor"><a href="#type-method_.OPTIONS" class="anchor"></a><code><span>| </span></code><code><span>`OPTIONS</span></code></td></tr><tr id="type-method_.TRACE" class="anchored"><td class="def constructor"><a href="#type-method_.TRACE" class="anchor"></a><code><span>| </span></code><code><span>`TRACE</span></code></td></tr><tr id="type-method_.PATCH" class="anchored"><td class="def constructor"><a href="#type-method_.PATCH" class="anchor"></a><code><span>| </span></code><code><span>`PATCH</span></code></td></tr><tr id="type-method_.Method" class="anchored"><td class="def constructor"><a href="#type-method_.Method" class="anchor"></a><code><span>| </span></code><code><span>`Method <span class="keyword">of</span> string</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>HTTP request methods. See <a href="https://tools.ietf.org/html/rfc7231#section-4.3">RFC 7231 §4.2</a>, <a href="https://tools.ietf.org/html/rfc5789#page-2">RFC 5789 §2</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">MDN</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-method_to_string" class="anchored"><a href="#val-method_to_string" class="anchor"></a><code><span><span class="keyword">val</span> method_to_string : <span><a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Evaluates to a string representation of the given method. For example, <code>`GET</code> is converted to <code>&quot;GET&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-string_to_method" class="anchored"><a href="#val-string_to_method" class="anchor"></a><code><span><span class="keyword">val</span> string_to_method : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-method_">method_</a></span></code></div><div class="spec-doc"><p>Evaluates to the <a href="#type-method_"><code>method_</code></a> corresponding to the given method string.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-methods_equal" class="anchored"><a href="#val-methods_equal" class="anchor"></a><code><span><span class="keyword">val</span> methods_equal : <span><a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Compares two methods, such that equal methods are detected even if one is represented as a string. For example,</p><pre><code>Dream.methods_equal `GET (`Method &quot;GET&quot;) = true</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-normalize_method" class="anchored"><a href="#val-normalize_method" class="anchor"></a><code><span><span class="keyword">val</span> normalize_method : <span><a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-method_">method_</a></span></code></div><div class="spec-doc"><p>Converts methods represented as strings to variants. Methods generated by Dream are always normalized.</p><pre><code>Dream.normalize_method (`Method &quot;GET&quot;) = `GET</code></pre></div></div><h2 id="status_codes"><a href="#status_codes" class="anchor"></a>Status codes</h2><div class="odoc-spec"><div class="spec type" id="type-informational" class="anchored"><a href="#type-informational" class="anchor"></a><code><span><span class="keyword">type</span> informational</span><span> = </span><span>[ </span></code><table><tr id="type-informational.Continue" class="anchored"><td class="def constructor"><a href="#type-informational.Continue" class="anchor"></a><code><span>| </span></code><code><span>`Continue</span></code></td></tr><tr id="type-informational.Switching_Protocols" class="anchored"><td class="def constructor"><a href="#type-informational.Switching_Protocols" class="anchor"></a><code><span>| </span></code><code><span>`Switching_Protocols</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Informational (<code>1xx</code>) status codes. See <a href="https://tools.ietf.org/html/rfc7231#section-6.2">RFC 7231 §6.2</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#information_responses">MDN</a>. <code>101 Switching Protocols</code> is generated internally by <a href="#val-websocket"><code>Dream.websocket</code></a>. It is usually not necessary to use it directly.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-successful" class="anchored"><a href="#type-successful" class="anchor"></a><code><span><span class="keyword">type</span> successful</span><span> = </span><span>[ </span></code><table><tr id="type-successful.OK" class="anchored"><td class="def constructor"><a href="#type-successful.OK" class="anchor"></a><code><span>| </span></code><code><span>`OK</span></code></td></tr><tr id="type-successful.Created" class="anchored"><td class="def constructor"><a href="#type-successful.Created" class="anchor"></a><code><span>| </span></code><code><span>`Created</span></code></td></tr><tr id="type-successful.Accepted" class="anchored"><td class="def constructor"><a href="#type-successful.Accepted" class="anchor"></a><code><span>| </span></code><code><span>`Accepted</span></code></td></tr><tr id="type-successful.Non_Authoritative_Information" class="anchored"><td class="def constructor"><a href="#type-successful.Non_Authoritative_Information" class="anchor"></a><code><span>| </span></code><code><span>`Non_Authoritative_Information</span></code></td></tr><tr id="type-successful.No_Content" class="anchored"><td class="def constructor"><a href="#type-successful.No_Content" class="anchor"></a><code><span>| </span></code><code><span>`No_Content</span></code></td></tr><tr id="type-successful.Reset_Content" class="anchored"><td class="def constructor"><a href="#type-successful.Reset_Content" class="anchor"></a><code><span>| </span></code><code><span>`Reset_Content</span></code></td></tr><tr id="type-successful.Partial_Content" class="anchored"><td class="def constructor"><a href="#type-successful.Partial_Content" class="anchor"></a><code><span>| </span></code><code><span>`Partial_Content</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Successful (<code>2xx</code>) status codes. See <a href="https://tools.ietf.org/html/rfc7231#section-6.3">RFC 7231 §6.3</a>, <a href="https://tools.ietf.org/html/rfc7233#section-4.1">RFC 7233 §4.1</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#successful_responses">MDN</a>. The most common is <code>200 OK</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-redirection" class="anchored"><a href="#type-redirection" class="anchor"></a><code><span><span class="keyword">type</span> redirection</span><span> = </span><span>[ </span></code><table><tr id="type-redirection.Multiple_Choices" class="anchored"><td class="def constructor"><a href="#type-redirection.Multiple_Choices" class="anchor"></a><code><span>| </span></code><code><span>`Multiple_Choices</span></code></td></tr><tr id="type-redirection.Moved_Permanently" class="anchored"><td class="def constructor"><a href="#type-redirection.Moved_Permanently" class="anchor"></a><code><span>| </span></code><code><span>`Moved_Permanently</span></code></td></tr><tr id="type-redirection.Found" class="anchored"><td class="def constructor"><a href="#type-redirection.Found" class="anchor"></a><code><span>| </span></code><code><span>`Found</span></code></td></tr><tr id="type-redirection.See_Other" class="anchored"><td class="def constructor"><a href="#type-redirection.See_Other" class="anchor"></a><code><span>| </span></code><code><span>`See_Other</span></code></td></tr><tr id="type-redirection.Not_Modified" class="anchored"><td class="def constructor"><a href="#type-redirection.Not_Modified" class="anchor"></a><code><span>| </span></code><code><span>`Not_Modified</span></code></td></tr><tr id="type-redirection.Temporary_Redirect" class="anchored"><td class="def constructor"><a href="#type-redirection.Temporary_Redirect" class="anchor"></a><code><span>| </span></code><code><span>`Temporary_Redirect</span></code></td></tr><tr id="type-redirection.Permanent_Redirect" class="anchored"><td class="def constructor"><a href="#type-redirection.Permanent_Redirect" class="anchor"></a><code><span>| </span></code><code><span>`Permanent_Redirect</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Redirection (<code>3xx</code>) status codes. See <a href="https://tools.ietf.org/html/rfc7231#section-6.4">RFC 7231 §6.4</a> and <a href="https://tools.ietf.org/html/rfc7538#section-3">RFC 7538 §3</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#redirection_messages">MDN</a>. Use <code>303 See Other</code> to direct clients to follow up with a <code>GET</code> request, especially after a form submission. Use <code>301 Moved Permanently</code> for permanent redirections.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-client_error" class="anchored"><a href="#type-client_error" class="anchor"></a><code><span><span class="keyword">type</span> client_error</span><span> = </span><span>[ </span></code><table><tr id="type-client_error.Bad_Request" class="anchored"><td class="def constructor"><a href="#type-client_error.Bad_Request" class="anchor"></a><code><span>| </span></code><code><span>`Bad_Request</span></code></td></tr><tr id="type-client_error.Unauthorized" class="anchored"><td class="def constructor"><a href="#type-client_error.Unauthorized" class="anchor"></a><code><span>| </span></code><code><span>`Unauthorized</span></code></td></tr><tr id="type-client_error.Payment_Required" class="anchored"><td class="def constructor"><a href="#type-client_error.Payment_Required" class="anchor"></a><code><span>| </span></code><code><span>`Payment_Required</span></code></td></tr><tr id="type-client_error.Forbidden" class="anchored"><td class="def constructor"><a href="#type-client_error.Forbidden" class="anchor"></a><code><span>| </span></code><code><span>`Forbidden</span></code></td></tr><tr id="type-client_error.Not_Found" class="anchored"><td class="def constructor"><a href="#type-client_error.Not_Found" class="anchor"></a><code><span>| </span></code><code><span>`Not_Found</span></code></td></tr><tr id="type-client_error.Method_Not_Allowed" class="anchored"><td class="def constructor"><a href="#type-client_error.Method_Not_Allowed" class="anchor"></a><code><span>| </span></code><code><span>`Method_Not_Allowed</span></code></td></tr><tr id="type-client_error.Not_Acceptable" class="anchored"><td class="def constructor"><a href="#type-client_error.Not_Acceptable" class="anchor"></a><code><span>| </span></code><code><span>`Not_Acceptable</span></code></td></tr><tr id="type-client_error.Proxy_Authentication_Required" class="anchored"><td class="def constructor"><a href="#type-client_error.Proxy_Authentication_Required" class="anchor"></a><code><span>| </span></code><code><span>`Proxy_Authentication_Required</span></code></td></tr><tr id="type-client_error.Request_Timeout" class="anchored"><td class="def constructor"><a href="#type-client_error.Request_Timeout" class="anchor"></a><code><span>| </span></code><code><span>`Request_Timeout</span></code></td></tr><tr id="type-client_error.Conflict" class="anchored"><td class="def constructor"><a href="#type-client_error.Conflict" class="anchor"></a><code><span>| </span></code><code><span>`Conflict</span></code></td></tr><tr id="type-client_error.Gone" class="anchored"><td class="def constructor"><a href="#type-client_error.Gone" class="anchor"></a><code><span>| </span></code><code><span>`Gone</span></code></td></tr><tr id="type-client_error.Length_Required" class="anchored"><td class="def constructor"><a href="#type-client_error.Length_Required" class="anchor"></a><code><span>| </span></code><code><span>`Length_Required</span></code></td></tr><tr id="type-client_error.Precondition_Failed" class="anchored"><td class="def constructor"><a href="#type-client_error.Precondition_Failed" class="anchor"></a><code><span>| </span></code><code><span>`Precondition_Failed</span></code></td></tr><tr id="type-client_error.Payload_Too_Large" class="anchored"><td class="def constructor"><a href="#type-client_error.Payload_Too_Large" class="anchor"></a><code><span>| </span></code><code><span>`Payload_Too_Large</span></code></td></tr><tr id="type-client_error.URI_Too_Long" class="anchored"><td class="def constructor"><a href="#type-client_error.URI_Too_Long" class="anchor"></a><code><span>| </span></code><code><span>`URI_Too_Long</span></code></td></tr><tr id="type-client_error.Unsupported_Media_Type" class="anchored"><td class="def constructor"><a href="#type-client_error.Unsupported_Media_Type" class="anchor"></a><code><span>| </span></code><code><span>`Unsupported_Media_Type</span></code></td></tr><tr id="type-client_error.Range_Not_Satisfiable" class="anchored"><td class="def constructor"><a href="#type-client_error.Range_Not_Satisfiable" class="anchor"></a><code><span>| </span></code><code><span>`Range_Not_Satisfiable</span></code></td></tr><tr id="type-client_error.Expectation_Failed" class="anchored"><td class="def constructor"><a href="#type-client_error.Expectation_Failed" class="anchor"></a><code><span>| </span></code><code><span>`Expectation_Failed</span></code></td></tr><tr id="type-client_error.Misdirected_Request" class="anchored"><td class="def constructor"><a href="#type-client_error.Misdirected_Request" class="anchor"></a><code><span>| </span></code><code><span>`Misdirected_Request</span></code></td></tr><tr id="type-client_error.Too_Early" class="anchored"><td class="def constructor"><a href="#type-client_error.Too_Early" class="anchor"></a><code><span>| </span></code><code><span>`Too_Early</span></code></td></tr><tr id="type-client_error.Upgrade_Required" class="anchored"><td class="def constructor"><a href="#type-client_error.Upgrade_Required" class="anchor"></a><code><span>| </span></code><code><span>`Upgrade_Required</span></code></td></tr><tr id="type-client_error.Precondition_Required" class="anchored"><td class="def constructor"><a href="#type-client_error.Precondition_Required" class="anchor"></a><code><span>| </span></code><code><span>`Precondition_Required</span></code></td></tr><tr id="type-client_error.Too_Many_Requests" class="anchored"><td class="def constructor"><a href="#type-client_error.Too_Many_Requests" class="anchor"></a><code><span>| </span></code><code><span>`Too_Many_Requests</span></code></td></tr><tr id="type-client_error.Request_Header_Fields_Too_Large" class="anchored"><td class="def constructor"><a href="#type-client_error.Request_Header_Fields_Too_Large" class="anchor"></a><code><span>| </span></code><code><span>`Request_Header_Fields_Too_Large</span></code></td></tr><tr id="type-client_error.Unavailable_For_Legal_Reasons" class="anchored"><td class="def constructor"><a href="#type-client_error.Unavailable_For_Legal_Reasons" class="anchor"></a><code><span>| </span></code><code><span>`Unavailable_For_Legal_Reasons</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Client error (<code>4xx</code>) status codes. The most common are <code>400 Bad Request</code>, <code>401 Unauthorized</code>, <code>403 Forbidden</code>, and, of course, <code>404 Not Found</code>.</p><p>See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#client_error_responses">MDN</a>, and</p><ul><li><a href="https://tools.ietf.org/html/rfc7231#section-6.5">RFC 7231 §6.5</a> for most client error status codes.</li><li><a href="https://tools.ietf.org/html/rfc7233#section-4.4">RFC 7233 §4.4</a> for <code>416 Range Not Satisfiable</code>.</li><li><a href="https://tools.ietf.org/html/rfc7540#section-9.1.2">RFC 7540 §9.1.2</a> for <code>421 Misdirected Request</code>.</li><li><a href="https://tools.ietf.org/html/rfc8470#section-5.2">RFC 8470 §5.2</a> for <code>425 Too Early</code>.</li><li><a href="https://tools.ietf.org/html/rfc6585">RFC 6585</a> for <code>428 Precondition Required</code>, <code>429 Too Many Requests</code>, and <code>431 Request
      Headers Too Large</code>.</li><li><a href="https://tools.ietf.org/html/rfc7725">RFC 7725</a> for <code>451 Unavailable For Legal Reasons</code>.</li></ul></div></div><div class="odoc-spec"><div class="spec type" id="type-server_error" class="anchored"><a href="#type-server_error" class="anchor"></a><code><span><span class="keyword">type</span> server_error</span><span> = </span><span>[ </span></code><table><tr id="type-server_error.Internal_Server_Error" class="anchored"><td class="def constructor"><a href="#type-server_error.Internal_Server_Error" class="anchor"></a><code><span>| </span></code><code><span>`Internal_Server_Error</span></code></td></tr><tr id="type-server_error.Not_Implemented" class="anchored"><td class="def constructor"><a href="#type-server_error.Not_Implemented" class="anchor"></a><code><span>| </span></code><code><span>`Not_Implemented</span></code></td></tr><tr id="type-server_error.Bad_Gateway" class="anchored"><td class="def constructor"><a href="#type-server_error.Bad_Gateway" class="anchor"></a><code><span>| </span></code><code><span>`Bad_Gateway</span></code></td></tr><tr id="type-server_error.Service_Unavailable" class="anchored"><td class="def constructor"><a href="#type-server_error.Service_Unavailable" class="anchor"></a><code><span>| </span></code><code><span>`Service_Unavailable</span></code></td></tr><tr id="type-server_error.Gateway_Timeout" class="anchored"><td class="def constructor"><a href="#type-server_error.Gateway_Timeout" class="anchor"></a><code><span>| </span></code><code><span>`Gateway_Timeout</span></code></td></tr><tr id="type-server_error.HTTP_Version_Not_Supported" class="anchored"><td class="def constructor"><a href="#type-server_error.HTTP_Version_Not_Supported" class="anchor"></a><code><span>| </span></code><code><span>`HTTP_Version_Not_Supported</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Server error (<code>5xx</code>) status codes. See <a href="https://tools.ietf.org/html/rfc7231#section-6.6">RFC 7231 §6.6</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#server_error_responses">MDN</a>. The most common of these is <code>500 Internal Server Error</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-standard_status" class="anchored"><a href="#type-standard_status" class="anchor"></a><code><span><span class="keyword">type</span> standard_status</span><span> = </span><span>[ </span></code><table><tr id="type-standard_status.informational" class="anchored"><td class="def type"><a href="#type-standard_status.informational" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-informational">informational</a></span></code></td></tr><tr id="type-standard_status.successful" class="anchored"><td class="def type"><a href="#type-standard_status.successful" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-successful">successful</a></span></code></td></tr><tr id="type-standard_status.redirection" class="anchored"><td class="def type"><a href="#type-standard_status.redirection" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-redirection">redirection</a></span></code></td></tr><tr id="type-standard_status.client_error" class="anchored"><td class="def type"><a href="#type-standard_status.client_error" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-client_error">client_error</a></span></code></td></tr><tr id="type-standard_status.server_error" class="anchored"><td class="def type"><a href="#type-standard_status.server_error" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-server_error">server_error</a></span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Sum of all the status codes declared above.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-status" class="anchored"><a href="#type-status" class="anchor"></a><code><span><span class="keyword">type</span> status</span><span> = </span><span>[ </span></code><table><tr id="type-status.standard_status" class="anchored"><td class="def type"><a href="#type-status.standard_status" class="anchor"></a><code><span>| </span></code><code><span><a href="#type-standard_status">standard_status</a></span></code></td></tr><tr id="type-status.Status" class="anchored"><td class="def constructor"><a href="#type-status.Status" class="anchor"></a><code><span>| </span></code><code><span>`Status <span class="keyword">of</span> int</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Status codes, including codes directly represented as integers. See the types above for the full list and references.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status_to_string" class="anchored"><a href="#val-status_to_string" class="anchor"></a><code><span><span class="keyword">val</span> status_to_string : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Evaluates to a string representation of the given status. For example, <code>`Not_Found</code> and <code>`Status 404</code> are both converted to <code>&quot;Not Found&quot;</code>. Numbers are used for unknown status codes. For example, <code>`Status 567</code> is converted to <code>&quot;567&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status_to_reason" class="anchored"><a href="#val-status_to_reason" class="anchor"></a><code><span><span class="keyword">val</span> status_to_reason : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>Converts known status codes to their string representations. Evaluates to <code>None</code> for unknown status codes.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status_to_int" class="anchored"><a href="#val-status_to_int" class="anchor"></a><code><span><span class="keyword">val</span> status_to_int : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Evaluates to the numeric value of the given status code.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-int_to_status" class="anchored"><a href="#val-int_to_status" class="anchor"></a><code><span><span class="keyword">val</span> int_to_status : <span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-status">status</a></span></code></div><div class="spec-doc"><p>Evaluates to the symbolic representation of the status code with the given number.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_informational" class="anchored"><a href="#val-is_informational" class="anchor"></a><code><span><span class="keyword">val</span> is_informational : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Evaluates to <code>true</code> if the given status is either from type <a href="#type-informational"><code>Dream.informational</code></a>, or is in the range <code>`Status 100</code> — <code>`Status 199</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_successful" class="anchored"><a href="#val-is_successful" class="anchor"></a><code><span><span class="keyword">val</span> is_successful : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Like <a href="#val-is_informational"><code>Dream.is_informational</code></a>, but for type <a href="#type-successful"><code>Dream.successful</code></a> and numeric codes <code>2xx</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_redirection" class="anchored"><a href="#val-is_redirection" class="anchor"></a><code><span><span class="keyword">val</span> is_redirection : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Like <a href="#val-is_informational"><code>Dream.is_informational</code></a>, but for type <a href="#type-redirection"><code>Dream.redirection</code></a> and numeric codes <code>3xx</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_client_error" class="anchored"><a href="#val-is_client_error" class="anchor"></a><code><span><span class="keyword">val</span> is_client_error : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Like <a href="#val-is_informational"><code>Dream.is_informational</code></a>, but for type <a href="#type-client_error"><code>Dream.client_error</code></a> and numeric codes <code>4xx</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-is_server_error" class="anchored"><a href="#val-is_server_error" class="anchor"></a><code><span><span class="keyword">val</span> is_server_error : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Like <a href="#val-is_informational"><code>Dream.is_informational</code></a>, but for type <a href="#type-server_error"><code>Dream.server_error</code></a> and numeric codes <code>5xx</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status_codes_equal" class="anchored"><a href="#val-status_codes_equal" class="anchor"></a><code><span><span class="keyword">val</span> status_codes_equal : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Compares two status codes, such that equal codes are detected even if one is represented as a number. For example,</p><pre><code>Dream.status_codes_equal `Not_Found (`Status 404) = true</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-normalize_status" class="anchored"><a href="#val-normalize_status" class="anchor"></a><code><span><span class="keyword">val</span> normalize_status : <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-status">status</a></span></code></div><div class="spec-doc"><p>Converts status codes represented as numbers to variants. Status codes generated by Dream are always normalized.</p><pre><code>Dream.normalize_status (`Status 404) = `Not_Found</code></pre></div></div><h2 id="requests"><a href="#requests" class="anchor"></a>Requests</h2><div class="odoc-spec"><div class="spec value" id="val-client" class="anchored"><a href="#val-client" class="anchor"></a><code><span><span class="keyword">val</span> client : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Client sending the request. For example, <code>&quot;127.0.0.1:56001&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-https" class="anchored"><a href="#val-https" class="anchor"></a><code><span><span class="keyword">val</span> https : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Whether the request was sent over HTTPS.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-method_" class="anchored"><a href="#val-method_" class="anchor"></a><code><span><span class="keyword">val</span> method_ : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-method_">method_</a></span></code></div><div class="spec-doc"><p>Request method. For example, <code>`GET</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-target" class="anchored"><a href="#val-target" class="anchor"></a><code><span><span class="keyword">val</span> target : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Request target. For example, <code>&quot;/foo/bar&quot;</code>. See <a href="#val-path"><code>Dream.path</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-path" class="anchored"><a href="#val-path" class="anchor"></a><code><span><span class="keyword">val</span> path : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>Parsed request path. For example, <code>&quot;foo&quot;; &quot;bar&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-version" class="anchored"><a href="#val-version" class="anchor"></a><code><span><span class="keyword">val</span> version : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> int * int</span></code></div><div class="spec-doc"><p>Protocol version. <code>(1, 1)</code> for HTTP/1.1 and <code>(2, 0)</code> for HTTP/2.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_client" class="anchored"><a href="#val-with_client" class="anchor"></a><code><span><span class="keyword">val</span> with_client : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p>Replaces the client. See <a href="#val-client"><code>Dream.client</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_method_" class="anchored"><a href="#val-with_method_" class="anchor"></a><code><span><span class="keyword">val</span> with_method_ : <span><a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p>Replaces the method. See <a href="#type-method_"><code>Dream.method_</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_path" class="anchored"><a href="#val-with_path" class="anchor"></a><code><span><span class="keyword">val</span> with_path : <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p>Replaces the path. See <a href="#val-path"><code>Dream.path</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_version" class="anchored"><a href="#val-with_version" class="anchor"></a><code><span><span class="keyword">val</span> with_version : <span><span>(int * int)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p>Replaces the version. See <a href="#val-version"><code>Dream.version</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-query" class="anchored"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>First query parameter with the given name. See <a href="https://tools.ietf.org/html/rfc3986#section-3.4">RFC 3986 §3.4</a> and example <a href="https://github.com/aantron/dream/tree/master/example/w-query#files"><code>w-query</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-queries" class="anchored"><a href="#val-queries" class="anchor"></a><code><span><span class="keyword">val</span> queries : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>All query parameters with the given name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-all_queries" class="anchored"><a href="#val-all_queries" class="anchor"></a><code><span><span class="keyword">val</span> all_queries : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Entire query string as a name-value list.</p></div></div><h2 id="responses"><a href="#responses" class="anchor"></a>Responses</h2><div class="odoc-spec"><div class="spec value" id="val-response" class="anchored"><a href="#val-response" class="anchor"></a><code><span><span class="keyword">val</span> response : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-response">response</a></span></code></div><div class="spec-doc"><p>Creates a new <a href="#type-response"><code>response</code></a> with the given string as body. <code>~code</code> and <code>~status</code> are two ways to specify the <a href="#type-status"><code>status</code></a> code, which is <code>200 OK</code> by default. The headers are empty by default.</p><p>Note that browsers may interpret lack of a <code>Content-Type:</code> header as if its value were <code>application/octet-stream</code> or <code>text/html; charset=us-ascii</code>, which will prevent correct interpretation of UTF-8 strings. Either add a <code>Content-Type:</code> header using <code>~headers</code> or <a href="#val-add_header"><code>Dream.add_header</code></a>, or use a wrapper like <a href="#val-html"><code>Dream.html</code></a>. The modern <code>Content-Type:</code> for HTML is <code>text/html; charset=utf-8</code>. See <a href="#val-text_html"><code>Dream.text_html</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-respond" class="anchored"><a href="#val-respond" class="anchor"></a><code><span><span class="keyword">val</span> respond : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-response"><code>Dream.response</code></a>, but the new <a href="#type-response"><code>response</code></a> is wrapped in a <a href="#type-promise"><code>promise</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-html" class="anchored"><a href="#val-html" class="anchor"></a><code><span><span class="keyword">val</span> html : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-respond"><code>Dream.respond</code></a>, but adds <code>Content-Type: text/html; charset=utf-8</code>. See <a href="#val-text_html"><code>Dream.text_html</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-json" class="anchored"><a href="#val-json" class="anchor"></a><code><span><span class="keyword">val</span> json : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-respond"><code>Dream.respond</code></a>, but adds <code>Content-Type: application/json</code>. See <a href="#val-application_json"><code>Dream.application_json</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-redirect" class="anchored"><a href="#val-redirect" class="anchor"></a><code><span><span class="keyword">val</span> redirect : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Creates a new <a href="#type-response"><code>response</code></a>. Adds a <code>Location:</code> header with the given string. The default status code is <code>303 See Other</code>, for a temporary redirection. Use <code>~status:`Moved_Permanently</code> or <code>~code:301</code> for a permanent redirection. The <a href="#type-request"><code>request</code></a> is used for retrieving the site prefix, if the string is an absolute path. Most applications don't have a site prefix.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-empty" class="anchored"><a href="#val-empty" class="anchor"></a><code><span><span class="keyword">val</span> empty : <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-response"><code>Dream.response</code></a> with the empty string for a body.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-stream" class="anchored"><a href="#val-stream" class="anchor"></a><code><span><span class="keyword">val</span> stream : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-respond"><code>Dream.respond</code></a>, but calls <a href="#val-with_stream"><code>Dream.with_stream</code></a> internally to prepare the response for stream writing, and then runs the callback asynchronously to do it. See example <a href="https://github.com/aantron/dream/tree/master/example/j-stream#files"><code>j-stream</code></a>.</p><pre><code>fun request -&gt;
  Dream.stream (fun response -&gt;
    let%lwt () = Dream.write response &quot;foo&quot; in
    Dream.close_stream response)</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-status" class="anchored"><a href="#val-status" class="anchor"></a><code><span><span class="keyword">val</span> status : <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-status">status</a></span></code></div><div class="spec-doc"><p>Response <a href="#type-status"><code>status</code></a>. For example, <code>`OK</code>.</p></div></div><h2 id="headers"><a href="#headers" class="anchor"></a>Headers</h2><div class="odoc-spec"><div class="spec value" id="val-header" class="anchored"><a href="#val-header" class="anchor"></a><code><span><span class="keyword">val</span> header : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>First header with the given name. Header names are case-insensitive. See <a href="https://tools.ietf.org/html/rfc7230#section-3.2">RFC 7230 §3.2</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers">MDN</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-headers" class="anchored"><a href="#val-headers" class="anchor"></a><code><span><span class="keyword">val</span> headers : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>All headers with the given name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-all_headers" class="anchored"><a href="#val-all_headers" class="anchor"></a><code><span><span class="keyword">val</span> all_headers : <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Entire header set as name-value list.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-has_header" class="anchored"><a href="#val-has_header" class="anchor"></a><code><span><span class="keyword">val</span> has_header : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Whether the message has a header with the given name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_header" class="anchored"><a href="#val-add_header" class="anchor"></a><code><span><span class="keyword">val</span> add_header : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>Appends a header with the given name and value. Does not remove any existing headers with the same name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-drop_header" class="anchored"><a href="#val-drop_header" class="anchor"></a><code><span><span class="keyword">val</span> drop_header : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>Removes all headers with the given name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_header" class="anchored"><a href="#val-with_header" class="anchor"></a><code><span><span class="keyword">val</span> with_header : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>Equivalent to <a href="#val-drop_header"><code>Dream.drop_header</code></a> followed by <a href="#val-add_header"><code>Dream.add_header</code></a>.</p></div></div><h2 id="cookies"><a href="#cookies" class="anchor"></a>Cookies</h2><p><a href="#val-set_cookie"><code>Dream.set_cookie</code></a> and <a href="#val-cookie"><code>Dream.cookie</code></a> are designed for round-tripping secure cookies. The most secure settings applicable to the current server are inferred automatically. See example <a href="https://github.com/aantron/dream/tree/master/example/c-cookie#files"><code>c-cookie</code></a> [<a href="http://dream.as/c-cookie">playground</a>].</p><pre><code>Dream.set_cookie &quot;my.cookie&quot; &quot;foo&quot; request response
Dream.cookie &quot;my.cookie&quot; request</code></pre><p>The <a href="#val-cookie"><code>Dream.cookie</code></a> call evaluates to <code>Some &quot;foo&quot;</code>, but the actual cookie that is exchanged may look like:</p><pre>__Host-my.cookie=AL7NLA8-so3e47uy0R5E2MpEQ0TtTWztdhq5pTEUT7KSFg; \
  Path=/; Secure; HttpOnly; SameSite=Strict</pre><p><a href="#val-set_cookie"><code>Dream.set_cookie</code></a> has a large number of optional arguments for tweaking the inferred security settings. If you use them, pass the same arguments to <a href="#val-cookie"><code>Dream.cookie</code></a> to automatically undo the result.</p><div class="odoc-spec"><div class="spec value" id="val-set_cookie" class="anchored"><a href="#val-set_cookie" class="anchor"></a><code><span><span class="keyword">val</span> set_cookie : <span>?prefix:<span><span>[ `Host <span>| `Secure</span> ]</span> option</span> <span class="arrow">&#45;&gt;</span></span> <span>?encrypt:bool <span class="arrow">&#45;&gt;</span></span>
<span>?expires:float <span class="arrow">&#45;&gt;</span></span> <span>?max_age:float <span class="arrow">&#45;&gt;</span></span> <span>?domain:string <span class="arrow">&#45;&gt;</span></span> <span>?path:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
<span>?secure:bool <span class="arrow">&#45;&gt;</span></span> <span>?http_only:bool <span class="arrow">&#45;&gt;</span></span> <span>?same_site:<span><span>[ `Strict <span>| `Lax</span> <span>| `None</span> ]</span> option</span> <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-response">response</a></span></code></div><div class="spec-doc"><p>Appends a <code>Set-Cookie:</code> header to the <a href="#type-response"><code>response</code></a>. Infers the most secure defaults from the <a href="#type-request"><code>request</code></a>.</p><pre><code>Dream.set_cookie &quot;my.cookie&quot; &quot;value&quot; request response</code></pre><p>Specify <a href="#val-run"><code>Dream.run</code></a> argument <code>~secret</code>, or the Web app will not be able to decrypt cookies from prior starts.</p><p>See example <a href="https://github.com/aantron/dream/tree/master/example/c-cookie#files"><code>c-cookie</code></a>.</p><p>Most of the optional arguments are for overriding inferred defaults. <code>~expires</code> and <code>~max_age</code> are independently useful. In particular, to delete a cookie, use <code>~expires:0.</code></p><ul><li><code>~prefix</code> sets <code>__Host-</code>, <code>__Secure-</code>, or no prefix, from most secure to least. A conforming client will refuse to accept the cookie if <code>~domain</code>, <code>~path</code>, and <code>~secure</code> don't match the constraints implied by the prefix. By default, <a href="#val-set_cookie"><code>Dream.set_cookie</code></a> chooses the most restrictive prefix based on the other settings and the <a href="#type-request"><code>request</code></a>. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.3">RFC 6265bis §4.1.3</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes">MDN</a>.</li><li><code>~encrypt:false</code> disables cookie encryption. In that case, you must make sure that the cookie value does not contain <code>=</code>, <code>;</code>, or newlines. The easiest way to do so is to pass the value through an encoder like <a href="#val-to_base64url"><code>Dream.to_base64url</code></a>. See <a href="#val-run"><code>Dream.run</code></a> argument <code>~secret</code>.</li><li><code>~expires</code> sets the <code>Expires=</code> attribute. The value is compatible with <a href="https://caml.inria.fr/pub/docs/manual-ocaml/libref/Unix.html#VALgettimeofday"><code>Unix.gettimeofday</code></a>. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.1">RFC 6265bis §4.1.2.1</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#define_the_lifetime_of_a_cookie">MDN</a>.</li><li><code>~max_age</code> sets the <code>Max-Age=</code> attribute. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.2">RFC 6265bis §4.1.2.2</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#define_the_lifetime_of_a_cookie">MDN</a>.</li><li><code>~domain</code> sets the <code>Domain=</code> attribute. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.3">RFC 6265bis §4.1.2.3</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Domain_attribute">MDN</a>.</li><li><code>~path</code> sets the <code>Path=</code> attribute. By default, <code>Path=</code> set to the site prefix in the <a href="#type-request"><code>request</code></a>, which is usually <code>/</code>. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.4">RFC 6265bis §4.1.2.4</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Path_attribute">MDN</a>.</li><li><code>~secure</code> sets the <code>Secure</code> attribute. By default, <code>Secure</code> is set if <a href="#val-https"><code>Dream.https</code></a> is <code>true</code> for the <a href="#type-request"><code>request</code></a>. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.5">RFC 6265bis §4.1.2.5</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">MDN</a>.</li><li><code>~http_only</code> sets the <code>HttpOnly</code> attribute. <code>HttpOnly</code> is set by default. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.6">RFC 6265bis §4.1.2.6</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">MDN</a>.</li><li><code>~same_site</code> sets the <code>SameSite=</code> attribute. <code>SameSite</code> is set to <code>Strict</code> by default. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.1.2.7">RFC 6265bis §4.1.2.7</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_attribute">MDN</a>.</li></ul><p><a href="#val-to_set_cookie"><code>Dream.to_set_cookie</code></a> is a “raw” version of this function that does not do any inference.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cookie" class="anchored"><a href="#val-cookie" class="anchor"></a><code><span><span class="keyword">val</span> cookie : <span>?prefix:<span><span>[ `Host <span>| `Secure</span> ]</span> option</span> <span class="arrow">&#45;&gt;</span></span> <span>?decrypt:bool <span class="arrow">&#45;&gt;</span></span>
<span>?domain:string <span class="arrow">&#45;&gt;</span></span> <span>?path:<span>string option</span> <span class="arrow">&#45;&gt;</span></span> <span>?secure:bool <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>First cookie with the given name. See example <a href="https://github.com/aantron/dream/tree/master/example/c-cookie#files"><code>c-cookie</code></a>.</p><pre><code>Dream.cookie &quot;my.cookie&quot; request</code></pre><p>Pass the same optional arguments as to <a href="#val-set_cookie"><code>Dream.set_cookie</code></a> for the same cookie. This will allow <a href="#val-cookie"><code>Dream.cookie</code></a> to infer the cookie name prefix, implementing a transparent cookie round trip with the most secure attributes applicable.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-all_cookies" class="anchored"><a href="#val-all_cookies" class="anchor"></a><code><span><span class="keyword">val</span> all_cookies : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>All cookies, with raw names and values.</p></div></div><h2 id="bodies"><a href="#bodies" class="anchor"></a>Bodies</h2><div class="odoc-spec"><div class="spec value" id="val-body" class="anchored"><a href="#val-body" class="anchor"></a><code><span><span class="keyword">val</span> body : <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Retrieves the entire body. Retains a reference to the body, so <a href="#val-body"><code>Dream.body</code></a> can be used multiple times. See example <a href="https://github.com/aantron/dream/tree/master/example/6-echo#files"><code>6-echo</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_body" class="anchored"><a href="#val-with_body" class="anchor"></a><code><span><span class="keyword">val</span> with_body : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-response">response</a></span></code></div><div class="spec-doc"><p>Replaces the body.</p></div></div><h3 id="streaming"><a href="#streaming" class="anchor"></a>Streaming</h3><div class="odoc-spec"><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Retrieves a body chunk. The chunk is not buffered, thus it can only be read once. See example <a href="https://github.com/aantron/dream/tree/master/example/j-stream#files"><code>j-stream</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_stream" class="anchored"><a href="#val-with_stream" class="anchor"></a><code><span><span class="keyword">val</span> with_stream : <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-response">response</a></span></code></div><div class="spec-doc"><p>Makes the <a href="#type-response"><code>response</code></a> ready for stream writing with <a href="#val-write"><code>Dream.write</code></a>. You should return it from your handler soon after — only one call to <a href="#val-write"><code>Dream.write</code></a> will be accepted before then. See <a href="#val-stream"><code>Dream.stream</code></a> for a more convenient wrapper.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Streams out the string. The promise is fulfilled when the response can accept more writes.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-flush" class="anchored"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Flushes write buffers. Data is sent to the client.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-close_stream" class="anchored"><a href="#val-close_stream" class="anchor"></a><code><span><span class="keyword">val</span> close_stream : <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Finishes the response stream.</p></div></div><h3 id="low-level-streaming"><a href="#low-level-streaming" class="anchor"></a>Low-level streaming</h3><div class="odoc-spec"><div class="spec type" id="type-buffer" class="anchored"><a href="#type-buffer" class="anchor"></a><code><span><span class="keyword">type</span> buffer</span><span> = <span><span>(char, <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/Bigarray/index.html#type-int8_unsigned_elt">Bigarray.int8_unsigned_elt</a>, <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/Bigarray/index.html#type-c_layout">Bigarray.c_layout</a>)</span> <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/Bigarray/Array1/index.html#type-t">Bigarray.Array1.t</a></span></span></code></div><div class="spec-doc"><p>Byte arrays in the C heap. See <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Bigarray.Array1.html"><code>Bigarray.Array1</code></a>. This type is also found in several libraries installed by Dream, so their functions can be used with <a href="#type-buffer"><code>Dream.buffer</code></a>:</p><ul><li><a href="https://github.com/inhabitedtype/bigstringaf/blob/353cb283aef4c261597f68154eb27a138e7ef112/lib/bigstringaf.mli"><code>Bigstringaf.t</code></a> in bigstringaf.</li><li><a href="https://ocsigen.org/lwt/latest/api/Lwt_bytes"><code>Lwt_bytes.t</code></a> in Lwt.</li><li><a href="https://github.com/mirage/ocaml-cstruct/blob/9a8b9a79bdfa2a1b8455bc26689e0228cc6fac8e/lib/cstruct.mli#L139"><code>Cstruct.buffer</code></a> in Cstruct.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-next" class="anchored"><a href="#val-next" class="anchor"></a><code><span><span class="keyword">val</span> next : <span>buffer:<span>(<span><a href="#type-buffer">buffer</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span>close:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span>exn:<span>(<span>exn <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Waits for the next stream event, and calls:</p><ul><li><code>~buffer</code> with an offset and length, if a <a href="#type-buffer"><code>buffer</code></a> is written,</li><li><code>~close</code> if close is requested, and</li><li><code>~exn</code> to report an exception.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-write_buffer" class="anchored"><a href="#val-write_buffer" class="anchor"></a><code><span><span class="keyword">val</span> write_buffer : <span>?offset:int <span class="arrow">&#45;&gt;</span></span> <span>?length:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-buffer">buffer</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Streams out the <a href="#type-buffer"><code>buffer</code></a> slice. <code>~offset</code> defaults to zero. <code>~length</code> defaults to the length of the <a href="#type-buffer"><code>buffer</code></a>, minus <code>~offset</code>.</p></div></div><h2 id="json"><a href="#json" class="anchor"></a>JSON</h2><p>Dream presently recommends using <a href="https://github.com/ocaml-community/yojson#readme">Yojson</a>. See also <a href="https://github.com/janestreet/ppx_yojson_conv#readme">ppx_yojson_conv</a> for generating JSON parsers and serializers for OCaml data types.</p><p>See example <a href="https://github.com/aantron/dream/tree/master/example/e-json#files"><code>e-json</code></a>.</p><div class="odoc-spec"><div class="spec value" id="val-origin_referer_check" class="anchored"><a href="#val-origin_referer_check" class="anchor"></a><code><span><span class="keyword">val</span> origin_referer_check : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>CSRF protection for AJAX requests. Either the method must be <code>`GET</code> or <code>`HEAD</code>, or:</p><ul><li><code>Origin:</code> or <code>Referer:</code> must be present, and</li><li>their value must match <code>Host:</code></li></ul><p>Responds with <code>400 Bad Request</code> if the check fails. See example <a href="https://github.com/aantron/dream/tree/master/example/e-json#security"><code>e-json</code></a>.</p><p>Implements the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#verifying-origin-with-standard-headers">OWASP <i>Verifying Origin With Standard Headers</i></a> CSRF defense-in-depth technique, which is good enough for basic usage. Do not allow <code>`GET</code> or <code>`HEAD</code> requests to trigger important side effects if relying only on <a href="#val-origin_referer_check"><code>Dream.origin_referer_check</code></a>.</p><p>Future extensions to this function may use <code>X-Forwarded-Host</code> or host whitelists.</p><p>For more thorough protection, generate CSRF tokens with <a href="#val-csrf_token"><code>Dream.csrf_token</code></a>, send them to the client (for instance, in <code>&lt;meta&gt;</code> tags of a single-page application), and require their presence in an <code>X-CSRF-Token:</code> header.</p></div></div><h2 id="forms"><a href="#forms" class="anchor"></a>Forms</h2><p><a href="#val-form_tag"><code>Dream.form_tag</code></a> and <a href="#val-form"><code>Dream.form</code></a> round-trip secure forms. <a href="#val-form_tag"><code>Dream.form_tag</code></a> is used inside a template to generate a form header with a CSRF token:</p><pre><code>&lt;%s! Dream.form_tag ~action:&quot;/&quot; request %&gt;
  &lt;input name=&quot;my.field&quot;&gt;
&lt;/form&gt;</code></pre><p><a href="#val-form"><code>Dream.form</code></a> recieves the form and checks the CSRF token:</p><pre><code>match%lwt Dream.form request with
| `Ok [&quot;my.field&quot;, value] -&gt; (* ... *)
| _ -&gt; Dream.empty `Bad_Request</code></pre><p>See example <a href="https://github.com/aantron/dream/tree/master/example/d-form#files"><code>d-form</code></a> [<a href="http://dream.as/d-form">playground</a>].</p><div class="odoc-spec"><div class="spec type" id="type-form_result" class="anchored"><a href="#type-form_result" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a form_result</span></span><span> = </span><span>[ </span></code><table><tr id="type-form_result.Ok" class="anchored"><td class="def constructor"><a href="#type-form_result.Ok" class="anchor"></a><code><span>| </span></code><code><span>`Ok <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-form_result.Expired" class="anchored"><td class="def constructor"><a href="#type-form_result.Expired" class="anchor"></a><code><span>| </span></code><code><span>`Expired <span class="keyword">of</span> <span class="type-var">'a</span> * float</span></code></td></tr><tr id="type-form_result.Wrong_session" class="anchored"><td class="def constructor"><a href="#type-form_result.Wrong_session" class="anchor"></a><code><span>| </span></code><code><span>`Wrong_session <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-form_result.Invalid_token" class="anchored"><td class="def constructor"><a href="#type-form_result.Invalid_token" class="anchor"></a><code><span>| </span></code><code><span>`Invalid_token <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-form_result.Missing_token" class="anchored"><td class="def constructor"><a href="#type-form_result.Missing_token" class="anchor"></a><code><span>| </span></code><code><span>`Missing_token <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-form_result.Many_tokens" class="anchored"><td class="def constructor"><a href="#type-form_result.Many_tokens" class="anchor"></a><code><span>| </span></code><code><span>`Many_tokens <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-form_result.Wrong_content_type" class="anchored"><td class="def constructor"><a href="#type-form_result.Wrong_content_type" class="anchor"></a><code><span>| </span></code><code><span>`Wrong_content_type</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Form CSRF checking results, in order from least to most severe. See <a href="#val-form"><code>Dream.form</code></a> and example <a href="https://github.com/aantron/dream/tree/master/example/d-form#files"><code>d-form</code></a>.</p><p>The first three constructors, <code>`Ok</code>, <code>`Expired</code>, and <code>`Wrong_session</code> can occur in regular usage.</p><p>The remaining constructors, <code>`Invalid_token</code>, <code>`Missing_token</code>, <code>`Many_tokens</code>, <code>`Wrong_content_type</code> correspond to bugs, suspicious activity, or tokens so old that decryption keys have since been rotated on the server.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-form" class="anchored"><a href="#val-form" class="anchor"></a><code><span><span class="keyword">val</span> form : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span>(string * string)</span> list</span> <a href="#type-form_result">form_result</a></span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Parses the request body as a form. Performs CSRF checks. Use <a href="#val-form_tag"><code>Dream.form_tag</code></a> in a template to transparently generate forms that will pass these checks. See <a href="#templates">Templates</a> and example <a href="https://github.com/aantron/dream/tree/master/example/d-form#readme"><code>d-form</code></a>.</p><ul><li><code>Content-Type:</code> must be <code>application/x-www-form-urlencoded</code>.</li><li>The form must have a field named <code>dream.csrf</code>. <a href="#val-form_tag"><code>Dream.form_tag</code></a> adds such a field.</li><li><a href="#val-form"><code>Dream.form</code></a> calls <a href="#val-verify_csrf_token"><code>Dream.verify_csrf_token</code></a> to check the token in <code>dream.csrf</code>.</li></ul><p>The call must be done under a session middleware, since each CSRF token is scoped to a session. See <a href="#sessions">Sessions</a>.</p><p>Form fields are sorted for easy pattern matching:</p><pre><code>match%lwt Dream.form request with
| `Ok [&quot;email&quot;, email; &quot;name&quot;, name] -&gt; (* ... *)
| _ -&gt; Dream.empty `Bad_Request</code></pre><p>To recover from conditions like expired forms, add extra cases:</p><pre><code>match%lwt Dream.form request with
| `Ok      [&quot;email&quot;, email; &quot;name&quot;, name] -&gt; (* ... *)
| `Expired [&quot;email&quot;, email; &quot;name&quot;, name] -&gt; (* ... *)
| _ -&gt; Dream.empty `Bad_Request</code></pre><p>It is recommended not to mutate state or send back sensitive data in the <code>`Expired</code> and <code>`Wrong_session</code> cases, as they <em>may</em> indicate an attack against a client.</p><p>The remaining cases, including unexpected field sets and the remaining constructors of <a href="#type-form_result"><code>Dream.form_result</code></a>, usually indicate either bugs or attacks. It's usually fine to respond to all of them with <code>400 Bad
    Request</code>.</p></div></div><h3 id="upload"><a href="#upload" class="anchor"></a>Upload</h3><div class="odoc-spec"><div class="spec type" id="type-multipart_form" class="anchored"><a href="#type-multipart_form" class="anchor"></a><code><span><span class="keyword">type</span> multipart_form</span><span> = <span><span>(string * <span><span>(<span>string option</span> * string)</span> list</span>)</span> list</span></span></code></div><div class="spec-doc"><p>Submitted file upload forms, <code>&lt;form enctype=&quot;multipart/form-data&quot;&gt;</code>. For example, if a form</p><pre>&lt;input name=&quot;files&quot; type=&quot;file&quot; multiple&gt;
&lt;input name=&quot;text&quot;&gt;</pre><p>is submitted with two files and a text value, it will be received by <a href="#val-multipart"><code>Dream.multipart</code></a> as</p><pre><code>[
  &quot;files&quot;, [
    Some &quot;file1.ext&quot;, &quot;file1-content&quot;;
    Some &quot;file2.ext&quot;, &quot;file2-content&quot;;
  ];
  &quot;text&quot;, [
    None, &quot;text-value&quot;
  ];
]</code></pre><p>See example <a href="https://github.com/aantron/dream/tree/master/example/g-upload#files"><code>g-upload</code></a> [<a href="http://dream.as/g-upload">playground</a>] and <a href="https://datatracker.ietf.org/doc/html/rfc7578">RFC 7578</a>.</p><p>Note that clients such as curl can send files with no filename (<code>None</code>), though most browsers seem to insert at least an empty filename (<code>Some &quot;&quot;</code>). Don't use use the presence of a filename to determine if the field value is a file. Use the field name and knowledge about the form instead.</p><p>If a file field has zero files when submitted, browsers send <code>&quot;field-name&quot;, [Some &quot;&quot;; &quot;&quot;]</code>. <a href="#val-multipart"><code>Dream.multipart</code></a> replaces this with <code>&quot;field-name&quot;, []</code>. Use the advanced interface <a href="#upload"><code>Dream:upload</code></a> for the raw behavior.</p><p>Non-file fields always have one value, which might be the empty string.</p><p>See <a href="https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html">OWASP <i>File Upload Cheat Sheet</i></a> for security precautions for upload forms.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-multipart" class="anchored"><a href="#val-multipart" class="anchor"></a><code><span><span class="keyword">val</span> multipart : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-multipart_form">multipart_form</a> <a href="#type-form_result">form_result</a></span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Like <a href="#val-form"><code>Dream.form</code></a>, but also reads files, and <code>Content-Type:</code> must be <code>multipart/form-data</code>. The <code>&lt;form&gt;</code> tag and CSRF token can be generated in a template with</p><pre><code>&lt;%s! Dream.form_tag ~action:&quot;/&quot;
       ~enctype:`Multipart_form_data request %&gt;</code></pre><p>See <a href="#val-form_tag"><code>Dream.form_tag</code></a>, section <a href="#templates">Templates</a>, and example <a href="https://github.com/aantron/dream/tree/master/example/g-upload#files"><code>g-upload</code></a>.</p><p>Note that, like <a href="#val-form"><code>Dream.form</code></a>, this function sorts form fields by field name.</p><p><a href="#val-multipart"><code>Dream.multipart</code></a> reads entire files into memory, so it is only suitable for prototyping, or with yet-to-be-added file size and count limits. See <a href="#val-upload"><code>Dream.upload</code></a> below for a streaming version.</p></div></div><h3 id="streaming-uploads"><a href="#streaming-uploads" class="anchor"></a>Streaming uploads</h3><div class="odoc-spec"><div class="spec type" id="type-part" class="anchored"><a href="#type-part" class="anchor"></a><code><span><span class="keyword">type</span> part</span><span> = <span>string option</span> * <span>string option</span> * <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Upload form parts.</p><p>A value <code>Some (name, filename, headers)</code> received by <a href="#val-upload"><code>Dream.upload</code></a> begins a <em>part</em> in the stream. A part represents either a form field, or a single, complete file.</p><p>Note that, in the general case, <code>filename</code> and <code>headers</code> are not reliable. <code>name</code> is the form field name.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-upload" class="anchored"><a href="#val-upload" class="anchor"></a><code><span><span class="keyword">val</span> upload : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-part">part</a> option</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Retrieves the next upload part.</p><p>Upon getting <code>Some (name, filename, headers)</code> from this function, the user should call <a href="#val-upload_part"><code>Dream.upload_part</code></a> to stream chunks of the part's data, until that function returns <code>None</code>. The user should then call <a href="#val-upload"><code>Dream.upload</code></a> again. <code>None</code> from <a href="#val-upload"><code>Dream.upload</code></a> indicates that all parts have been received.</p><p><a href="#upload"><code>Dream:upload</code></a> does not verify a CSRF token. There are several ways to add CSRF protection for an upload stream, including:</p><ul><li>Generate the form with <a href="#val-form_tag"><code>Dream.form_tag</code></a>. Check for <code>`Field (&quot;dream.csrf&quot;, token)</code> during upload and call <a href="#val-verify_csrf_token"><code>Dream.verify_csrf_token</code></a>.</li><li>Use <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData"><code>FormData</code></a> in the client to submit <code>multipart/form-data</code> by AJAX, and include a custom header.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-upload_part" class="anchored"><a href="#val-upload_part" class="anchor"></a><code><span><span class="keyword">val</span> upload_part : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Retrieves a part chunk.</p></div></div><h3 id="csrf-tokens"><a href="#csrf-tokens" class="anchor"></a>CSRF tokens</h3><p>It's usually not necessary to handle CSRF tokens directly.</p><ul><li>Form tag generator <a href="#val-form_tag"><code>Dream.form_tag</code></a> generates and inserts a CSRF token that <a href="#val-form"><code>Dream.form</code></a> and <a href="#val-multipart"><code>Dream.multipart</code></a> transparently verify.</li><li>AJAX can be protected from CSRF by <a href="#val-origin_referer_check"><code>Dream.origin_referer_check</code></a>.</li></ul><p>CSRF functions are exposed for creating custom schemes, and for defense-in-depth purposes. See <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">OWASP <i>Cross-Site Request Forgery Prevention Cheat Sheet</i></a>.</p><div class="odoc-spec"><div class="spec type" id="type-csrf_result" class="anchored"><a href="#type-csrf_result" class="anchor"></a><code><span><span class="keyword">type</span> csrf_result</span><span> = </span><span>[ </span></code><table><tr id="type-csrf_result.Ok" class="anchored"><td class="def constructor"><a href="#type-csrf_result.Ok" class="anchor"></a><code><span>| </span></code><code><span>`Ok</span></code></td></tr><tr id="type-csrf_result.Expired" class="anchored"><td class="def constructor"><a href="#type-csrf_result.Expired" class="anchor"></a><code><span>| </span></code><code><span>`Expired <span class="keyword">of</span> float</span></code></td></tr><tr id="type-csrf_result.Wrong_session" class="anchored"><td class="def constructor"><a href="#type-csrf_result.Wrong_session" class="anchor"></a><code><span>| </span></code><code><span>`Wrong_session</span></code></td></tr><tr id="type-csrf_result.Invalid" class="anchored"><td class="def constructor"><a href="#type-csrf_result.Invalid" class="anchor"></a><code><span>| </span></code><code><span>`Invalid</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>CSRF token verification outcomes.</p><p><code>`Expired</code> and <code>`Wrong_session</code> can occur in normal usage, when a user's form or session expire, respectively. However, they can also indicate attacks, including stolen tokens, stolen tokens from other sessions, or attempts to use a token from an invalidated pre-session after login.</p><p><code>`Invalid</code> indicates a token with a bad signature, a payload that was not generated by Dream, or other serious errors that cannot usually be triggered by normal users. <code>`Invalid</code> usually corresponds to bugs or attacks. <code>`Invalid</code> can also occur for very old tokens after old keys are no longer in use on the server.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-csrf_token" class="anchored"><a href="#val-csrf_token" class="anchor"></a><code><span><span class="keyword">val</span> csrf_token : <span>?valid_for:float <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Returns a fresh CSRF token bound to the given request's and signed with the <code>~secret</code> given to <a href="#val-run"><code>Dream.run</code></a>. <code>~valid_for</code> is the token's lifetime, in seconds. The default value is one hour (<code>3600.</code>). Dream uses signed tokens that are not stored server-side.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-verify_csrf_token" class="anchored"><a href="#val-verify_csrf_token" class="anchor"></a><code><span><span class="keyword">val</span> verify_csrf_token : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-csrf_result">csrf_result</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Checks that the CSRF token is valid for the <a href="#type-request"><code>request</code></a>'s session.</p></div></div><h2 id="templates"><a href="#templates" class="anchor"></a>Templates</h2><p>Dream includes a template preprocessor that allows interleaving OCaml and HTML in the same file:</p><pre>let render message =
  &lt;html&gt;
    &lt;body&gt;
      &lt;p&gt;The message is &lt;b&gt;&lt;%s message %&gt;&lt;/b&gt;!&lt;/p&gt;
    &lt;/body&gt;
  &lt;/html&gt;</pre><p>See examples <a href="https://github.com/aantron/dream/tree/master/example/7-template#files"><code>7-template</code></a> [<a href="http://dream.as/7-template">playground</a>] and <a href="https://github.com/aantron/dream/tree/master/example/r-template#files"><code>r-template</code></a> [<a href="http://dream.as/r-template">playground</a>].</p><p>There is also a typed alternative, provided by an external library, <a href="https://github.com/ocsigen/tyxml">TyXML</a>. It is shown in example <a href="https://github.com/aantron/dream/tree/master/example/w-tyxml#files"><code>w-tyxml</code></a> [<a href="http://dream.as/w-tyxml">playground</a>]. If you are using Reason syntax, TyXML can be used with <a href="https://ocsigen.org/tyxml/latest/manual/jsx">server-side JSX</a>. See example <a href="https://github.com/aantron/dream/tree/master/example/r-tyxml#files"><code>r-tyxml</code></a> [<a href="http://dream.as/r-tyxml">playground</a>].</p><p>To use the built-in templates, add this to <code>dune</code>:</p><pre>(rule
 (targets template.ml)
 (deps template.eml.ml)
 (action (run dream_eml %{deps} --workspace %{workspace_root})))</pre><p>A template begins...</p><ul><li><em>Implicitly</em> on a line that starts with <code>&lt;</code>, perhaps with leading whitespace. The line is part of the template.</li><li><em>Explicitly</em> after a line that starts with <code>%%</code>. The <code>%%</code> line is not part of the template.</li></ul><p>A <code>%%</code> line can also be used to set template options. The only option supported presently is <code>%% response</code> for streaming the template using <a href="#val-write"><code>Dream.write</code></a>, to a <a href="#type-response"><code>response</code></a> that is in scope. This is shown in examples <a href="https://github.com/aantron/dream/tree/master/example/w-template-stream#files"><code>w-template-stream</code></a> and <a href="https://github.com/aantron/dream/tree/master/example/r-template-stream#files"><code>r-template-stream</code></a>.</p><p>A template ends...</p><ul><li><em>Implicitly</em>, when the indentation level is less than that of the beginning line.</li><li><em>Explicitly</em> on a line that starts with another <code>%%</code>.</li></ul><p>Everything outside a template is ordinary OCaml code.</p><p>OCaml code can also be inserted into a template:</p><ul><li><code>&lt;%s code %&gt;</code> expects <code>code</code> to evaluate to a <code>string</code>, and inserts the <code>string</code> into the template.</li><li>A line that begins with <code>%</code> in the first column is OCaml code inside the template. Its value is not inserted into the template. Indeed, it can be fragments of control-flow constructs.</li><li><code>&lt;% code %&gt;</code> is a variant of <code>%</code> that can be used for short snippets within template lines.</li></ul><p>The <code>s</code> in <code>&lt;%s code %&gt;</code> is actually a <a href="https://caml.inria.fr/pub/docs/manual-ocaml/libref/Printf.html">Printf</a>-style format specification. So, for example, one can print two hex digits using <code>&lt;%02X code %&gt;</code>.</p><p><code>&lt;%s code %&gt;</code> automatically escapes the result of <code>code</code> using <a href="#val-html_escape"><code>Dream.html_escape</code></a>. This can be suppressed with <code>!</code>. <code>&lt;%s! code %&gt;</code> prints the result of <code>code</code> literally. <a href="#val-html_escape"><code>Dream.html_escape</code></a> is only safe for use in HTML text and quoted attribute values. It does not offer XSS protection in unquoted attribute values, CSS in <code>&lt;style&gt;</code> tags, or literal JavaScript in <code>&lt;script&gt;</code> tags.</p><div class="odoc-spec"><div class="spec value" id="val-form_tag" class="anchored"><a href="#val-form_tag" class="anchor"></a><code><span><span class="keyword">val</span> form_tag : <span>?enctype:<span>[ `Multipart_form_data ]</span> <span class="arrow">&#45;&gt;</span></span> <span>action:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Generates a <code>&lt;form&gt;</code> tag and an <code>&lt;input&gt;</code> tag with a CSRF token, suitable for use with <a href="#val-form"><code>Dream.form</code></a> and <a href="#val-multipart"><code>Dream.multipart</code></a>. For example, in a template,</p><pre><code>&lt;%s! Dream.form_tag ~action:&quot;/&quot; request %&gt;
  &lt;input name=&quot;my.field&quot;&gt;
&lt;/form&gt;</code></pre><p>expands to</p><pre><code>&lt;form method=&quot;POST&quot; action=&quot;/&quot;&gt;
  &lt;input name=&quot;dream.csrf&quot; type=&quot;hidden&quot; value=&quot;a-token&quot;&gt;
  &lt;input name=&quot;my.field&quot;&gt;
&lt;/form&gt;</code></pre><p>Pass <code>~enctype:`Multipart_form_data</code> for a file upload form.</p></div></div><h2 id="middleware"><a href="#middleware" class="anchor"></a>Middleware</h2><p>Interesting built-in middlewares are scattered throughout the various sections of these docs, according to where they are relevant. This section contains only generic middleware combinators.</p><div class="odoc-spec"><div class="spec value" id="val-no_middleware" class="anchored"><a href="#val-no_middleware" class="anchor"></a><code><span><span class="keyword">val</span> no_middleware : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Does nothing but call its inner handler. Useful for disabling middleware conditionally during application startup:</p><pre><code>if development then
  my_middleware
else
  Dream.no_middleware</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-pipeline" class="anchored"><a href="#val-pipeline" class="anchor"></a><code><span><span class="keyword">val</span> pipeline : <span><span><a href="#type-middleware">middleware</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Combines a sequence of middlewares into one, such that these two lines are equivalent:</p><pre>Dream.pipeline [middleware_1; middleware_2] @@ handler</pre><pre>               middleware_1 @@ middleware_2 @@ handler</pre></div></div><h2 id="routing"><a href="#routing" class="anchor"></a>Routing</h2><div class="odoc-spec"><div class="spec value" id="val-router" class="anchored"><a href="#val-router" class="anchor"></a><code><span><span class="keyword">val</span> router : <span><span><a href="#type-route">route</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Creates a router. Besides interpreting routes, a router is a middleware which calls its next handler if none of its routes match the request. Route components starting with <code>:</code> are parameters, which can be retrieved with <a href="#val-param"><code>Dream.param</code></a>. See example <a href="https://github.com/aantron/dream/tree/master/example/3-router#files"><code>3-router</code></a> [<a href="http://dream.as/3-router">playground</a>].</p><pre><code>let () =
  Dream.run
  @@ Dream.router [
    Dream.get &quot;/echo/:word&quot; @@ fun request -&gt;
      Dream.html (Dream.param &quot;word&quot; request);
  ]
  @@ Dream.not_found</code></pre><p><a href="#val-scope"><code>Dream.scope</code></a> is the main form of site composition. However, Dream also supports full subsites with <code>**</code>:</p><pre><code>let () =
  Dream.run
  @@ Dream.router [
    Dream.get &quot;/static/**&quot; @@ Dream.static &quot;www/static&quot;;
  ]
  @@ Dream.not_found</code></pre><p><code>**</code> causes the request's path to be trimmed by the route prefix, and the request's prefix to be extended by it. It is mainly useful for “mounting” <a href="#val-static"><code>Dream.static</code></a> as a subsite.</p><p>It can also be used as an escape hatch to convert a handler, which may include its own router, into a subsite. However, it is better to compose sites with routes and <a href="#val-scope"><code>Dream.scope</code></a> rather than opaque handlers and <code>**</code>, because, in the future, it may be possible to query routes for site structure metadata.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-get" class="anchored"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div><div class="spec-doc"><p>Forwards <code>`GET</code> requests for the given path to the handler.</p><pre><code>Dream.get &quot;/home&quot; home_template</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-post" class="anchored"><a href="#val-post" class="anchor"></a><code><span><span class="keyword">val</span> post : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-put" class="anchored"><a href="#val-put" class="anchor"></a><code><span><span class="keyword">val</span> put : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-delete" class="anchored"><a href="#val-delete" class="anchor"></a><code><span><span class="keyword">val</span> delete : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-head" class="anchored"><a href="#val-head" class="anchor"></a><code><span><span class="keyword">val</span> head : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-connect" class="anchored"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-options" class="anchored"><a href="#val-options" class="anchor"></a><code><span><span class="keyword">val</span> options : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-trace" class="anchored"><a href="#val-trace" class="anchor"></a><code><span><span class="keyword">val</span> trace : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-patch" class="anchored"><a href="#val-patch" class="anchor"></a><code><span><span class="keyword">val</span> patch : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div><div class="spec-doc"><p>Like <a href="#val-get"><code>Dream.get</code></a>, but for each of the other <a href="#type-method_">methods</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-any" class="anchored"><a href="#val-any" class="anchor"></a><code><span><span class="keyword">val</span> any : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div><div class="spec-doc"><p>Like <a href="#val-get"><code>Dream.get</code></a>, but does not check the method.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-not_found" class="anchored"><a href="#val-not_found" class="anchor"></a><code><span><span class="keyword">val</span> not_found : <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Always responds with <code>404 Not Found</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-param" class="anchored"><a href="#val-param" class="anchor"></a><code><span><span class="keyword">val</span> param : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Retrieves the path parameter. If it is missing, <a href="#val-param"><code>Dream.param</code></a> raises an exception — the program is buggy.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-scope" class="anchored"><a href="#val-scope" class="anchor"></a><code><span><span class="keyword">val</span> scope : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-middleware">middleware</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-route">route</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-route">route</a></span></code></div><div class="spec-doc"><p>Groups routes under a common path prefix and middlewares. Middlewares are run only if a route matches.</p><pre><code>Dream.scope &quot;/api&quot; [Dream.origin_referer_check] [
  Dream.get  &quot;/widget&quot; get_widget_handler;
  Dream.post &quot;/widget&quot; set_widget_handler;
]</code></pre><p>To prefix routes without applying any more middleware, use the empty list:</p><pre><code>Dream.scope &quot;/api&quot; [] [
  (* ...routes... *)
]</code></pre><p>To apply middleware without prefixing the routes, use <code>&quot;/&quot;</code>:</p><pre><code>Dream.scope &quot;/&quot; [Dream.origin_referer_check] [
  (* ...routes... *)
]</code></pre><p>Scopes can be nested.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-no_route" class="anchored"><a href="#val-no_route" class="anchor"></a><code><span><span class="keyword">val</span> no_route : <a href="#type-route">route</a></span></code></div><div class="spec-doc"><p>A dummy value of type <a href="#type-route"><code>route</code></a> that is completely ignored by the router. Useful for disabling routes conditionally during application start:</p><pre><code>Dream.router [
  if development then
    Dream.get &quot;/graphiql&quot; (Dream.graphiql &quot;/graphql&quot;)
  else
    Dream.no_route;
]</code></pre></div></div><h2 id="static-files"><a href="#static-files" class="anchor"></a>Static files</h2><div class="odoc-spec"><div class="spec value" id="val-static" class="anchored"><a href="#val-static" class="anchor"></a><code><span><span class="keyword">val</span> static : <span>?loader:<span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Serves static files from a local directory. See example <a href="https://github.com/aantron/dream/tree/master/example/f-static#files"><code>f-static</code></a>.</p><pre><code>let () =
  Dream.run
  @@ Dream.router {
    Dream.get &quot;/static/**&quot; @@ Dream.static &quot;www/static&quot;;
  }
  @@ Dream.not_found</code></pre><p><code>Dream.static local_directory</code> validates the path substituted for <code>**</code> by checking that it is (1) relative, (2) does not contain parent directory references (<code>..</code>), and (3) does not contain separators (<code>/</code>) within components. If these checks fail, <a href="#val-static"><code>Dream.static</code></a> responds with <code>404 Not
    Found</code>.</p><p>If the checks succeed, <a href="#val-static"><code>Dream.static</code></a> calls <code>~loader local_directory path
    request</code>, where</p><ul><li><code>local_directory</code> is the same directory that was passed to <a href="#val-static"><code>Dream.static</code></a>.</li><li><code>path</code> is what was substituted for <code>**</code>.</li></ul><p>The default loader is <a href="#val-from_filesystem"><code>Dream.from_filesystem</code></a>. See example <a href="https://github.com/aantron/dream/tree/master/example/w-one-binary#files"><code>w-one-binary</code></a> for a loader that serves files from memory instead.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_filesystem" class="anchored"><a href="#val-from_filesystem" class="anchor"></a><code><span><span class="keyword">val</span> from_filesystem : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p><code>Dream.from_filesystem local_directory path request</code> responds with a file from the file system found at <code>local_directory ^ &quot;/&quot; ^ path</code>. If such a file does not exist, it responds with <code>404 Not Found</code>.</p><p>To serve single files like <code>sitemap.xml</code> from the file system, use routes like</p><pre><code>Dream.get &quot;/sitemap.xml&quot; (Dream.from_filesystem &quot;assets&quot; &quot;sitemap.xml&quot;)</code></pre><p><a href="#val-from_filesystem"><code>Dream.from_filesystem</code></a> calls <a href="#val-mime_lookup"><code>Dream.mime_lookup</code></a> to guess a <code>Content-Type:</code> based on the file's extension.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-mime_lookup" class="anchored"><a href="#val-mime_lookup" class="anchor"></a><code><span><span class="keyword">val</span> mime_lookup : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Returns a <code>Content-Type:</code> header based on the given filename. This is mostly a wrapper around <a href="https://github.com/mirage/ocaml-magic-mime">magic-mime</a>. However, if the result is <code>text/html</code>, <a href="#val-mime_lookup"><code>Dream.mime_lookup</code></a> replaces it with <code>text/html; charset=utf-8</code>, so as to match <a href="#val-html"><code>Dream.html</code></a>.</p></div></div><h2 id="sessions"><a href="#sessions" class="anchor"></a>Sessions</h2><p>Dream's default sessions contain string-to-string dictionaries for application data. For example, a logged-in session might have</p><pre><code>[
  &quot;user&quot;, &quot;someone&quot;;
  &quot;lang&quot;, &quot;ut-OP&quot;;
]</code></pre><p>Sessions also have three pieces of metadata:</p><ul><li><a href="#val-session_id"><code>Dream.session_id</code></a></li><li><a href="#val-session_label"><code>Dream.session_label</code></a></li><li><a href="#val-session_expires_at"><code>Dream.session_expires_at</code></a></li></ul><p>There are several back ends, which decide where the sessions are stored:</p><ul><li><a href="#val-memory_sessions"><code>Dream.memory_sessions</code></a></li><li><a href="#val-sql_sessions"><code>Dream.sql_sessions</code></a></li><li><a href="#val-cookie_sessions"><code>Dream.cookie_sessions</code></a></li></ul><p>All requests passing through session middleware are assigned a session, either an existing one, or a new empty session, known as a <em>pre-session</em>.</p><p>See example <a href="https://github.com/aantron/dream/tree/master/example/b-session#files"><code>b-session</code></a> [<a href="http://dream.as/b-session">playground</a>].</p><div class="odoc-spec"><div class="spec value" id="val-session" class="anchored"><a href="#val-session" class="anchor"></a><code><span><span class="keyword">val</span> session : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>Value from the request's session.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-put_session" class="anchored"><a href="#val-put_session" class="anchor"></a><code><span><span class="keyword">val</span> put_session : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Mutates a value in the request's session. The back end may commit the value to storage immediately, so this function returns a promise.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-all_session_values" class="anchored"><a href="#val-all_session_values" class="anchor"></a><code><span><span class="keyword">val</span> all_session_values : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Full session dictionary.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-invalidate_session" class="anchored"><a href="#val-invalidate_session" class="anchor"></a><code><span><span class="keyword">val</span> invalidate_session : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Invalidates the request's session, replacing it with a fresh, empty pre-session.</p></div></div><h3 id="back-ends"><a href="#back-ends" class="anchor"></a>Back ends</h3><div class="odoc-spec"><div class="spec value" id="val-memory_sessions" class="anchored"><a href="#val-memory_sessions" class="anchor"></a><code><span><span class="keyword">val</span> memory_sessions : <span>?lifetime:float <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Stores sessions in server memory. Passes session IDs to clients in cookies. Session data is lost when the server process exits.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cookie_sessions" class="anchored"><a href="#val-cookie_sessions" class="anchor"></a><code><span><span class="keyword">val</span> cookie_sessions : <span>?lifetime:float <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Stores sessions in encrypted cookies. Pass <a href="#val-run"><code>Dream.run</code></a> <code>~secret</code> to be able to decrypt cookies from previous server runs.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-sql_sessions" class="anchored"><a href="#val-sql_sessions" class="anchor"></a><code><span><span class="keyword">val</span> sql_sessions : <span>?lifetime:float <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Stores sessions in an SQL database. Passes session IDs to clients in cookies. Must be used under <a href="#val-sql_pool"><code>Dream.sql_pool</code></a>. Expects a table</p><pre>CREATE TABLE dream_session (
  id TEXT PRIMARY KEY,
  label TEXT NOT NULL,
  expires_at REAL NOT NULL,
  payload TEXT NOT NULL
)</pre></div></div><h3 id="metadata"><a href="#metadata" class="anchor"></a>Metadata</h3><div class="odoc-spec"><div class="spec value" id="val-session_id" class="anchored"><a href="#val-session_id" class="anchor"></a><code><span><span class="keyword">val</span> session_id : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Secret value used to identify a client.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-session_label" class="anchored"><a href="#val-session_label" class="anchor"></a><code><span><span class="keyword">val</span> session_label : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Tracing label suitable for printing to logs.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-session_expires_at" class="anchored"><a href="#val-session_expires_at" class="anchor"></a><code><span><span class="keyword">val</span> session_expires_at : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div><div class="spec-doc"><p>Time at which the session will expire.</p></div></div><h2 id="websockets"><a href="#websockets" class="anchor"></a>WebSockets</h2><div class="odoc-spec"><div class="spec type" id="type-websocket" class="anchored"><a href="#type-websocket" class="anchor"></a><code><span><span class="keyword">type</span> websocket</span></code></div><div class="spec-doc"><p>A WebSocket connection. See <a href="https://tools.ietf.org/html/rfc6455">RFC 6455</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">MDN</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-websocket" class="anchored"><a href="#val-websocket" class="anchor"></a><code><span><span class="keyword">val</span> websocket : <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-websocket">websocket</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Creates a fresh <code>101 Switching Protocols</code> response. Once this response is returned to Dream's HTTP layer, the callback is passed a new <a href="#type-websocket"><code>websocket</code></a>, and the application can begin using it. See example <a href="https://github.com/aantron/dream/tree/master/example/k-websocket#files"><code>k-websocket</code></a> [<a href="http://dream.as/k-websocket">playground</a>].</p><pre><code>let my_handler = fun request -&gt;
  Dream.websocket (fun websocket -&gt;
    let%lwt () = Dream.send websocket &quot;Hello, world!&quot; in
    Dream.close_websocket websocket);</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-send" class="anchored"><a href="#val-send" class="anchor"></a><code><span><span class="keyword">val</span> send : <span>?kind:<span>[ `Text <span>| `Binary</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-websocket">websocket</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Sends a single message. The WebSocket is ready another message when the promise resolves.</p><p>With <code>~kind:`Text</code>, the default, the message is interpreted as a UTF-8 string. The client will receive it transcoded to JavaScript's UTF-16 representation.</p><p>With <code>~kind:`Binary</code>, the message will be received unmodified, as either a <code>Blob</code> or an <code>ArrayBuffer</code>. See <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/binaryType">MDN, <code>WebSocket.binaryType</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-receive" class="anchored"><a href="#val-receive" class="anchor"></a><code><span><span class="keyword">val</span> receive : <span><a href="#type-websocket">websocket</a> <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Retrieves a message. If the WebSocket is closed before a complete message arrives, the result is <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-close_websocket" class="anchored"><a href="#val-close_websocket" class="anchor"></a><code><span><span class="keyword">val</span> close_websocket : <span>?code:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-websocket">websocket</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Closes the WebSocket. <code>~code</code> is usually not necessary, but is needed for some protocols based on WebSockets. See <a href="https://tools.ietf.org/html/rfc6455#section-7.4">RFC 6455 §7.4</a>.</p></div></div><h2 id="graphql"><a href="#graphql" class="anchor"></a>GraphQL</h2><p>Dream integrates <a href="https://github.com/andreas/ocaml-graphql-server#readme">ocaml-graphql-server</a>. See examples:</p><ul><li><a href="https://github.com/aantron/dream/tree/master/example/i-graphql#files"><code>i-graphql</code></a> [<a href="http://dream.as/i-graphql">playground</a>]</li><li><a href="https://github.com/aantron/dream/tree/master/example/r-graphql#files"><code>r-graphql</code></a> [<a href="http://dream.as/r-graphql">playground</a>]</li><li><a href="https://github.com/aantron/dream/tree/master/example/w-graphql-subscription#files"><code>w-graphql-subscription</code></a> [<a href="http://dream.as/w-graphql-subscription">playground</a>].</li></ul><p>If you are also <a href="https://github.com/aantron/dream/tree/master/example#full-stack">writing a client in a flavor of OCaml</a>, consider <a href="https://github.com/reasonml-community/graphql-ppx">graphql-ppx</a> for generating GraphQL queries.</p><p>See <a href="https://cheatsheetseries.owasp.org/cheatsheets/GraphQL_Cheat_Sheet.html">OWASP <i>GraphQL Cheat Sheet</i></a> for an overview of security topics related to GraphQL.</p><div class="odoc-spec"><div class="spec value" id="val-graphql" class="anchored"><a href="#val-graphql" class="anchor"></a><code><span><span class="keyword">val</span> graphql : <span><span>(<span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Graphql_lwt</span>.Schema.schema</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p><code>Dream.graphql make_context schema</code> serves the GraphQL <code>schema</code>.</p><pre><code>let () =
  Dream.run
  @@ Dream.router [
    Dream.any &quot;/graphql&quot;  (Dream.graphql Lwt.return schema);
    Dream.get &quot;/graphiql&quot; (Dream.graphiql &quot;/graphql&quot;);
  ]
  @@ Dream.not_found</code></pre><p><code>make_context</code> is called by <a href="#val-graphql"><code>Dream.graphql</code></a> on every <a href="#type-request"><code>request</code></a> to create the <em>context</em>, a value that is passed to each resolver from the schema. Passing <code>Lwt.return</code>, the same as</p><pre><code>fun request -&gt; Lwt.return request</code></pre><p>causes the <a href="#type-request"><code>request</code></a> itself to be used as the context:</p><pre><code>field &quot;name&quot;
  ~doc:&quot;User name&quot;
  ~typ:(non_null string)
  ~args:Arg.[]
  ~resolve:(fun info user -&gt;
    (* The context is in info.ctx *)
    user.name);</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-graphiql" class="anchored"><a href="#val-graphiql" class="anchor"></a><code><span><span class="keyword">val</span> graphiql : <span>?default_query:string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Serves <a href="https://github.com/graphql/graphiql/tree/main/packages/graphiql#readme">GraphiQL</a>, a GraphQL query editor. The string gives the GraphQL endpoint that the editor will work with.</p><p><code>~default_query</code> sets the query that appears upon the first visit to the endpoint. It is empty by default. The string is pasted literally into the content of a JavaScript string, between its quotes, so it must be escaped manually.</p><p>Dream's build of GraphiQL is found in the <a href="https://github.com/aantron/dream/tree/master/src/graphiql">src/graphiql</a> directory. If you have the need, you can use it as the starting point for your own customized GraphiQL.</p><p>Use <a href="#val-no_route"><code>Dream.no_route</code></a> to disable GraphiQL conditionally outside of development.</p></div></div><h2 id="sql"><a href="#sql" class="anchor"></a>SQL</h2><p>Dream provides thin convenience functions over <a href="https://github.com/paurkedal/ocaml-caqti/#readme">Caqti</a>, an SQL interface with several back ends. See example <a href="https://github.com/aantron/dream/tree/master/example/h-sql#files"><code>h-sql</code></a> [<a href="http://dream.as/h-sql">playground</a>].</p><p>Dream installs the core <a href="https://opam.ocaml.org/packages/caqti/"><code>caqti</code></a> package, but you should also install at least one of:</p><ul><li><a href="https://opam.ocaml.org/packages/caqti-driver-sqlite3/"><code>caqti-driver-sqlite3</code></a></li><li><a href="https://opam.ocaml.org/packages/caqti-driver-postgresql/"><code>caqti-driver-postgresql</code></a></li><li><a href="https://opam.ocaml.org/packages/caqti-driver-mariadb/"><code>caqti-driver-mariadb</code></a></li></ul><p>They are separated because each has its own system library dependencies. Regardless of which you install, usage on the OCaml level is the same. The differences are in SQL syntax, and in external SQL server or file setup. See</p><ul><li><a href="https://sqlite.org/lang.html">SQLite3, <i>SQL As Understood By SQLite</i></a></li><li><a href="https://www.postgresql.org/docs/13/sql.html">PostgreSQL, <i>The SQL Language</i></a></li><li><a href="https://mariadb.com/kb/en/sql-statements-structure/">MariaDB, <i>SQL Statements &amp; Structure</i></a></li></ul><p>For a superficial overview of database security, see <a href="https://cheatsheetseries.owasp.org/cheatsheets/Database_Security_Cheat_Sheet.html">OWASP <i>Database Security Cheat Sheet</i></a>.</p><div class="odoc-spec"><div class="spec value" id="val-sql_pool" class="anchored"><a href="#val-sql_pool" class="anchor"></a><code><span><span class="keyword">val</span> sql_pool : <span>?size:int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Makes an SQL connection pool available to its inner handler.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-sql" class="anchored"><a href="#val-sql" class="anchor"></a><code><span><span class="keyword">val</span> sql : <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Caqti_lwt</span>.connection <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Runs the callback with a connection from the SQL pool. See example <a href="https://github.com/aantron/dream/tree/master/example/h-sql#files"><code>h-sql</code></a>.</p><pre><code>let () =
  Dream.run
  @@ Dream.sql_pool &quot;sqlite3://db.sqlite&quot;
  @@ fun request -&gt;
    Dream.sql request (fun db -&gt;
      (* ... *) |&gt; Dream.html)</code></pre></div></div><h2 id="logging"><a href="#logging" class="anchor"></a>Logging</h2><p>Dream uses the <a href="https://erratique.ch/software/logs/doc/Logs/index.html">Logs</a> library internally, and integrates with all other libraries in your project that are also using it. Dream provides a slightly simplified interface to Logs.</p><p>All log output is written to <code>stderr</code>.</p><p>See <a href="https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html">OWASP <i>Logging Cheat Sheet</i></a> for a survey of security topics related to logging.</p><div class="odoc-spec"><div class="spec value" id="val-logger" class="anchored"><a href="#val-logger" class="anchor"></a><code><span><span class="keyword">val</span> logger : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Logs and times requests. Time spent logging is included. See example <a href="https://github.com/aantron/dream/tree/master/example/2-middleware#files"><code>2-middleware</code></a> [<a href="http://dream.as/2-middleware">playground</a>].</p></div></div><div class="odoc-spec"><div class="spec value" id="val-log" class="anchored"><a href="#val-log" class="anchor"></a><code><span><span class="keyword">val</span> log : <span><span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/Format/index.html#type-formatter">Format.formatter</a>, unit, unit)</span> <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/index.html#type-format4">format4</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Formats a message and logs it. Disregard the obfuscated type: the first argument is a format string as described in the standard library modules <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Printf.html#VALfprintf"><code>Printf</code></a> and <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Format.html#VALfprintf"><code>Format</code></a>. The rest of the arguments are determined by the format string. See example <a href="https://github.com/aantron/dream/tree/master/example/a-log#files"><code>a-log</code></a> [<a href="http://dream.as/a-log">playground</a>].</p><pre><code>Dream.log &quot;Counter is now: %i&quot; counter;
Dream.log &quot;Client: %s&quot; (Dream.client request);</code></pre></div></div><div class="odoc-spec"><div class="spec type" id="type-conditional_log" class="anchored"><a href="#type-conditional_log" class="anchor"></a><code><span><span class="keyword">type</span> <span>('a, 'b) conditional_log</span></span><span> = <span><span>(<span><span>(<span>?request:<a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/Format/index.html#type-formatter">Format.formatter</a>, unit, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/4.12.0/Stdlib/index.html#type-format4">format4</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Loggers. This type is difficult to read — instead, see <a href="#val-error"><code>Dream.error</code></a> for usage.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-log_level" class="anchored"><a href="#type-log_level" class="anchor"></a><code><span><span class="keyword">type</span> log_level</span><span> = </span><span>[ </span></code><table><tr id="type-log_level.Error" class="anchored"><td class="def constructor"><a href="#type-log_level.Error" class="anchor"></a><code><span>| </span></code><code><span>`Error</span></code></td></tr><tr id="type-log_level.Warning" class="anchored"><td class="def constructor"><a href="#type-log_level.Warning" class="anchor"></a><code><span>| </span></code><code><span>`Warning</span></code></td></tr><tr id="type-log_level.Info" class="anchored"><td class="def constructor"><a href="#type-log_level.Info" class="anchor"></a><code><span>| </span></code><code><span>`Info</span></code></td></tr><tr id="type-log_level.Debug" class="anchored"><td class="def constructor"><a href="#type-log_level.Debug" class="anchor"></a><code><span>| </span></code><code><span>`Debug</span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Log levels, in order from most urgent to least.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-error" class="anchored"><a href="#val-error" class="anchor"></a><code><span><span class="keyword">val</span> error : <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span></span></code></div><div class="spec-doc"><p>Formats a message and writes it to the log at level <code>`Error</code>. The inner formatting function is called only if the <a href="#val-initialize_log">current log level</a> is <code>`Error</code> or higher. See example <a href="https://github.com/aantron/dream/tree/master/example/a-log#files"><code>a-log</code></a>.</p><pre><code>Dream.error (fun log -&gt;
  log ~request &quot;My message, details: %s&quot; details);</code></pre><p>Pass the optional argument <code>~request</code> to <a href="#val-error"><code>Dream.error</code></a> to associate the message with a specific request. If not passed, <a href="#val-error"><code>Dream.error</code></a> will try to guess the request. This usually works, but not always.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-warning" class="anchored"><a href="#val-warning" class="anchor"></a><code><span><span class="keyword">val</span> warning : <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-info" class="anchored"><a href="#val-info" class="anchor"></a><code><span><span class="keyword">val</span> info : <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-debug" class="anchored"><a href="#val-debug" class="anchor"></a><code><span><span class="keyword">val</span> debug : <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span></span></code></div><div class="spec-doc"><p>Like <a href="#val-error"><code>Dream.error</code></a>, but for each of the other <a href="#type-log_level">log levels</a>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-sub_log" class="anchored"><a href="#type-sub_log" class="anchor"></a><code><span><span class="keyword">type</span> sub_log</span><span> = </span><span>{</span></code><table><tr id="type-sub_log.error" class="anchored"><td class="def record field"><a href="#type-sub_log.error" class="anchor"></a><code><span>error : a. <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span>;</span></code></td></tr><tr id="type-sub_log.warning" class="anchored"><td class="def record field"><a href="#type-sub_log.warning" class="anchor"></a><code><span>warning : a. <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span>;</span></code></td></tr><tr id="type-sub_log.info" class="anchored"><td class="def record field"><a href="#type-sub_log.info" class="anchor"></a><code><span>info : a. <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span>;</span></code></td></tr><tr id="type-sub_log.debug" class="anchored"><td class="def record field"><a href="#type-sub_log.debug" class="anchor"></a><code><span>debug : a. <span><span>(<span class="type-var">'a</span>, unit)</span> <a href="#type-conditional_log">conditional_log</a></span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Sub-logs. See <a href="#val-sub_log"><code>Dream.sub_log</code></a> right below.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-sub_log" class="anchored"><a href="#val-sub_log" class="anchor"></a><code><span><span class="keyword">val</span> sub_log : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-sub_log">sub_log</a></span></code></div><div class="spec-doc"><p>Creates a new sub-log with the given name. For example,</p><pre><code>let log = Dream.sub_log &quot;myapp.ajax&quot;</code></pre><p>...creates a logger that can be used like <a href="#val-error"><code>Dream.error</code></a> and the other default loggers, but prefixes <code>&quot;myapp.ajax&quot;</code> to each log message.</p><pre><code>log.error (fun log -&gt; log ~request &quot;Validation failed&quot;)</code></pre><p>See <code>README</code> of example <a href="https://github.com/aantron/dream/tree/master/example/a-log#files"><code>a-log</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-initialize_log" class="anchored"><a href="#val-initialize_log" class="anchor"></a><code><span><span class="keyword">val</span> initialize_log : <span>?backtraces:bool <span class="arrow">&#45;&gt;</span></span> <span>?async_exception_hook:bool <span class="arrow">&#45;&gt;</span></span> <span>?level:<a href="#type-log_level">log_level</a> <span class="arrow">&#45;&gt;</span></span>
<span>?enable:bool <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Initializes Dream's log with the given settings.</p><p>Dream initializes its logging back end lazily. This is so that if a Dream Web app is linked into a larger binary, it does not affect that binary's runtime unless the Web app runs.</p><p>This also allows the Web app to give logging settings explicitly by calling <a href="#val-initialize_log"><code>Dream.initialize_log</code></a> early in program execution.</p><ul><li><code>~backtraces:true</code>, the default, causes Dream to call <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Printexc.html#VALrecord_backtrace"><code>Printexc.record_backtrace</code></a>, which makes exception backtraces available.</li></ul><ul><li><code>~async_exception_hook:true</code>, the default, causes Dream to set <a href="https://ocsigen.org/lwt/latest/api/Lwt#VALasync_exception_hook"><code>Lwt.async_exception_hook</code></a> so as to forward all asynchronous exceptions to the logger, and not terminate the process.</li></ul><ul><li><code>~level</code> sets the log level threshould for the entire binary. The default is <code>`Info</code>.</li></ul><ul><li><code>~enable:false</code> disables Dream logging completely. This can help sanitize output during testing.</li></ul></div></div><h2 id="errors"><a href="#errors" class="anchor"></a>Errors</h2><p>Dream passes all errors to a single error handler, including...</p><ul><li>exceptions and rejected promises from the application,</li><li><code>4xx</code> and <code>5xx</code> responses from the application, and</li><li>lower-level errors, such as TLS handshake failures and malformed HTTP requests.</li></ul><p>This allows customizing error handling in one place. Including low-level errors prevents leakage of strings in automatic responses not under the application's control, for full internationalization.</p><p>Use <a href="#val-error_template"><code>Dream.error_template</code></a> and pass the result to <a href="#val-run"><code>Dream.run</code></a> <code>~error_handler</code> to customize the error template.</p><p>The default error handler logs errors and its template generates completely empty responses, to avoid internationalization issues. In addition, this conforms to the recommendations in <a href="https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html">OWASP <i>Error Handling Cheat Sheet</i></a>.</p><p>For full control over error handling, including logging, you can define an <a href="#type-error_handler"><code>error_handler</code></a> directly.</p><div class="odoc-spec"><div class="spec type" id="type-error" class="anchored"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span><span>{</span></code><table><tr id="type-error.condition" class="anchored"><td class="def record field"><a href="#type-error.condition" class="anchor"></a><code><span>condition : <span>[ <span>`Response of <a href="#type-response">response</a></span> <span><span>| `String</span> of string</span> <span><span>| `Exn</span> of exn</span> ]</span>;</span></code></td></tr><tr id="type-error.layer" class="anchored"><td class="def record field"><a href="#type-error.layer" class="anchor"></a><code><span>layer : <span>[ `App <span>| `HTTP</span> <span>| `HTTP2</span> <span>| `TLS</span> <span>| `WebSocket</span> ]</span>;</span></code></td></tr><tr id="type-error.caused_by" class="anchored"><td class="def record field"><a href="#type-error.caused_by" class="anchor"></a><code><span>caused_by : <span>[ `Server <span>| `Client</span> ]</span>;</span></code></td></tr><tr id="type-error.request" class="anchored"><td class="def record field"><a href="#type-error.request" class="anchor"></a><code><span>request : <span><a href="#type-request">request</a> option</span>;</span></code></td></tr><tr id="type-error.response" class="anchored"><td class="def record field"><a href="#type-error.response" class="anchor"></a><code><span>response : <span><a href="#type-response">response</a> option</span>;</span></code></td></tr><tr id="type-error.client" class="anchored"><td class="def record field"><a href="#type-error.client" class="anchor"></a><code><span>client : <span>string option</span>;</span></code></td></tr><tr id="type-error.severity" class="anchored"><td class="def record field"><a href="#type-error.severity" class="anchor"></a><code><span>severity : <a href="#type-log_level">log_level</a>;</span></code></td></tr><tr id="type-error.debug" class="anchored"><td class="def record field"><a href="#type-error.debug" class="anchor"></a><code><span>debug : bool;</span></code></td></tr><tr id="type-error.will_send_response" class="anchored"><td class="def record field"><a href="#type-error.will_send_response" class="anchor"></a><code><span>will_send_response : bool;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Detailed errors. Ignore this type if only using <a href="#val-error_template"><code>Dream.error_template</code></a>.</p><ul><li><p><code>condition</code> describes the error itself.</p><ul><li><code>`Response</code> is a <code>4xx</code> or <code>5xx</code> response.</li><li><code>`String</code> is an error that has only an English-language description.</li><li><code>`Exn</code> is a caught exception.</li></ul><p>The default error handler logs <code>`Exn</code> and <code>`Strings</code>, but not <code>`Response</code>. <code>`Response</code> is assumed to be deliberate, and already logged by <a href="#val-logger"><code>Dream.logger</code></a>.</p></li><li><p><code>layer</code> is which part of the Dream stack detected the error.</p><ul><li><code>`App</code> is for application exceptions, rejections, and <code>4xx</code>, <code>5xx</code> responses.</li><li><code>`HTTP</code> and <code>`HTTP2</code> are for low-level HTTP protocol errors.</li><li><code>`TLS</code> is for low-level TLS errors.</li><li><code>`WebSocket</code> is for WebSocket errors.</li></ul><p>The default error handler uses this to just prepend a prefix to its log messages.</p></li><li><p><code>caused_by</code> is the party likely to have caused the error.</p><ul><li><code>`Server</code> errors suggest bugs, and correspond to <code>5xx</code> responses.</li><li><code>`Client</code> errors suggest user errors, network failure, buggy clients, and sometimes attacks. They correspond to <code>4xx</code> responses.</li></ul></li><li><p><code>request</code> is a <a href="#type-request"><code>request</code></a> associated with the error, if there is one.</p><p>As examples, a request might not be available if the error is a failure to parse an HTTP/1.1 request at all, or failure to perform a TLS handshake.</p><p>In case of a <code>`WebSocket</code> error, the request is the client's original request to establish the WebSocket connection.</p></li><li><p><code>response</code> is a <a href="#type-response"><code>response</code></a> that was either generated by the application, or suggested by the error context.</p><p>In case of a <code>`WebSocket</code> error, the response is the application's original connection agreement response created by <a href="#val-websocket"><code>Dream.websocket</code></a>.</p><p>See <a href="#val-error_template"><code>Dream.error_template</code></a>.</p></li><li><code>client</code> is the client's address, if available. For example, <code>127.0.0.1:56001</code>.</li><li>Suggested <a href="#type-log_level">log level</a> for the error. Usually <code>`Error</code> for <code>`Server</code> errors and <code>`Warning</code> for client errors.</li><li><p><code>debug</code> is <code>true</code> if <a href="#val-run"><code>Dream.run</code></a> was called with <code>~debug</code>.</p><p>If so, the default error handler gathers various fields from the current request, formats the error condition, and passes the resulting string to the template as <code>debug_dump</code>.</p><p>The default template shows this string in its repsonse, instead of returning a response with no body.</p></li><li><p><code>will_send_response</code> is <code>true</code> in error contexts where Dream will still send a response.</p><p>The default handler calls the error template only if <code>will_send_response</code> is <code>true</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec type" id="type-error_handler" class="anchored"><a href="#type-error_handler" class="anchor"></a><code><span><span class="keyword">type</span> error_handler</span><span> = <span><a href="#type-error">error</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-response">response</a> option</span> <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Error handlers log errors and convert them into responses. Ignore if using <a href="#val-error_template"><code>Dream.error_template</code></a>.</p><p>If the error has <code>will_send_response = true</code>, the error handler must return a response. Otherwise, it should return <code>None</code>.</p><p>If an error handler raises an exception or rejects, Dream logs this secondary failure. If the error context needs a response, Dream responds with an empty <code>500 Internal Server Error</code>.</p><p>The behavior of Dream's default error handler is described at <a href="#type-error"><code>Dream.error</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-error_template" class="anchored"><a href="#val-error_template" class="anchor"></a><code><span><span class="keyword">val</span> error_template : <span><span>(<span><span>string option</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-error_handler">error_handler</a></span></code></div><div class="spec-doc"><p>Builds an <a href="#type-error_handler"><code>error_handler</code></a> from a template. See example <a href="https://github.com/aantron/dream/tree/master/example/9-error#files"><code>9-error</code></a> [<a href="http://dream.as/9-error">playground</a>].</p><pre><code>let my_error_handler =
  Dream.error_template (fun ~debug_dump suggested_response -&gt;
    let body =
      match debug_dump with
      | Some string -&gt; Dream.html_escape string
      | None -&gt; Dream.status_to_string (Dream.status suggested_response)
    in

    suggested_response
    |&gt; Dream.with_body body
    |&gt; Lwt.return)</code></pre><p>The error's context suggests a response. Usually, its only valid field is <a href="#val-status"><code>Dream.status</code></a>.</p><ul><li>If the error is an exception or rejection from the application, the status is usually <code>500 Internal Server Error</code>.</li><li>In case of a <code>4xx</code> or <code>5xx</code> response from the application, that response itself is passed to the template.</li><li>For low-level errors, the status is typically either <code>400 Bad Request</code> if the error was likely caused by the client, and <code>500 Internal Server Error</code> if the error was likely caused by the server.</li></ul><p>If <code>~debug</code> was passed to <a href="#val-run"><code>Dream.run</code></a>, <code>~debug_dump</code> will be <code>Some info</code>, where <code>info</code> is a multi-line string containing an error description, stack trace, request state, and other information.</p><p>When an error occurs in a context where a response is not possible, the template is not called. In some contexts where the template is called, the status code is hardcoded, but the headers and body from the template's response will still be used.</p><p>If the template itself raises an exception or rejects, an empty <code>500
    Internal Server Error</code> will be sent in contexts that require a response.</p></div></div><h2 id="servers"><a href="#servers" class="anchor"></a>Servers</h2><div class="odoc-spec"><div class="spec value" id="val-run" class="anchored"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span>?interface:string <span class="arrow">&#45;&gt;</span></span> <span>?port:int <span class="arrow">&#45;&gt;</span></span> <span>?stop:<span>unit <a href="#type-promise">promise</a></span> <span class="arrow">&#45;&gt;</span></span> <span>?debug:bool <span class="arrow">&#45;&gt;</span></span>
<span>?error_handler:<a href="#type-error_handler">error_handler</a> <span class="arrow">&#45;&gt;</span></span> <span>?secret:string <span class="arrow">&#45;&gt;</span></span> <span>?old_secrets:<span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span>?prefix:string <span class="arrow">&#45;&gt;</span></span>
<span>?https:bool <span class="arrow">&#45;&gt;</span></span> <span>?certificate_file:string <span class="arrow">&#45;&gt;</span></span> <span>?key_file:string <span class="arrow">&#45;&gt;</span></span> <span>?builtins:bool <span class="arrow">&#45;&gt;</span></span>
<span>?greeting:bool <span class="arrow">&#45;&gt;</span></span> <span>?adjust_terminal:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Runs the Web application represented by the <a href="#type-handler"><code>handler</code></a>, by default at <a href="http://localhost:8080">http://localhost:8080</a>.</p><p>This function calls <a href="https://ocsigen.org/lwt/latest/api/Lwt_main#VALrun"><code>Lwt_main.run</code></a> internally, so it is intended to be the main loop of a program. <a href="#val-serve"><code>Dream.serve</code></a> is a version that does not call <code>Lwt_main.run</code>.</p><ul><li><code>~interface</code> is the network interface to listen on. Defaults to <code>&quot;localhost&quot;</code>. Use <code>&quot;0.0.0.0&quot;</code> to listen on all interfaces.</li><li><code>~port</code> is the port to listen on. Defaults to <code>8080</code>.</li><li><code>~stop</code> is a promise that causes the server to stop accepting new requests, and <a href="#val-run"><code>Dream.run</code></a> to return. Requests that have already entered the Web application continue to be processed. The default value is a promise that never resolves. However, see also <code>~stop_on_input</code>.</li><li><code>~debug:true</code> enables debug information in error templates. See <a href="#val-error_template"><code>Dream.error_template</code></a>. The default is <code>false</code>, to prevent accidental deployment with debug output turned on. See example <a href="https://github.com/aantron/dream/tree/master/example/8-debug#files"><code>8-debug</code></a> [<a href="http://dream.as/8-debug">playground</a>].</li><li><code>~error_handler</code> handles all errors, both from the application, and low-level errors. See <a href="#errors">Errors</a> and example <a href="https://github.com/aantron/dream/tree/master/example/9-error#files"><code>9-error</code></a> [<a href="http://dream.as/9-error">playground</a>].</li><li><p><code>~secret</code> is a key to be used for cryptographic operations, such as signing CSRF tokens. By default, a random secret is generated on each call to <a href="#val-run"><code>Dream.run</code></a>. For production, generate a 256-bit key with</p><pre><code>Dream.to_base64url (Dream.random 32)</code></pre><p>and load it from file. A medium-sized Web app serving 1000 fresh encrypted cookies per second should rotate keys about once a year. See argument <code>~old_secrets</code> below for key rotation. See <a href="#val-encrypt"><code>Dream.encrypt</code></a> for cipher information.</p></li><li><code>~old_secrets</code> is a list of previous secrets that can still be used for decryption, but not for encryption. This is intended for key rotation.</li><li><code>~prefix</code> is a site prefix for applications that are not running at the root (<code>/</code>) of their domain. The default is <code>&quot;/&quot;</code>, for no prefix.</li><li><code>~https:true</code> enables HTTPS. You should also specify <code>~certificate_file</code> and <code>~key_file</code>. However, for development, Dream includes an insecure compiled-in <a href="https://github.com/aantron/dream/tree/master/src/certificate#files">localhost certificate</a>. Enabling HTTPS also enables transparent upgrading of connections to HTTP/2. See example <a href="https://github.com/aantron/dream/tree/master/example/l-https#files"><code>l-https</code></a>.</li><li><code>~certificate_file</code> and <code>~key_file</code> specify the certificate and key file, respectively, when using <code>~https</code>. They are not required for development, but are required for production. Dream will write a warning to the log if you are using <code>~https</code>, don't provide <code>~certificate_file</code> and <code>~key_file</code>, and <code>~interface</code> is not <code>&quot;localhost&quot;</code>.</li><li><code>~builtins:false</code> disables <a href="#builtin">Built-in middleware</a>.</li></ul><p>The remaining arguments can be used to gradually disable convenience features of <code>Dream.run</code>. Once both are disabled, you may want to switch to using <a href="#val-serve"><code>Dream.serve</code></a>.</p><ul><li><code>~greeting:false</code> disables the start-up log message that prints a link to the Web application.</li><li><code>~adjust_terminal:false</code> disables adjusting the terminal to disable echo and line wrapping.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-serve" class="anchored"><a href="#val-serve" class="anchor"></a><code><span><span class="keyword">val</span> serve : <span>?interface:string <span class="arrow">&#45;&gt;</span></span> <span>?port:int <span class="arrow">&#45;&gt;</span></span> <span>?stop:<span>unit <a href="#type-promise">promise</a></span> <span class="arrow">&#45;&gt;</span></span> <span>?debug:bool <span class="arrow">&#45;&gt;</span></span>
<span>?error_handler:<a href="#type-error_handler">error_handler</a> <span class="arrow">&#45;&gt;</span></span> <span>?secret:string <span class="arrow">&#45;&gt;</span></span> <span>?old_secrets:<span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span>?prefix:string <span class="arrow">&#45;&gt;</span></span>
<span>?https:bool <span class="arrow">&#45;&gt;</span></span> <span>?certificate_file:string <span class="arrow">&#45;&gt;</span></span> <span>?key_file:string <span class="arrow">&#45;&gt;</span></span> <span>?builtins:bool <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="#type-promise">promise</a></span></span></code></div><div class="spec-doc"><p>Like <a href="#val-run"><code>Dream.run</code></a>, but returns a promise that does not resolve until the server stops listening, instead of calling <a href="https://ocsigen.org/lwt/latest/api/Lwt_main#VALrun"><code>Lwt_main.run</code></a>.</p><p>This function is meant for integrating Dream applications into larger programs that have their own procedures for starting and stopping the Web server.</p><p>All arguments have the same meanings as they have in <a href="#val-run"><code>Dream.run</code></a>.</p></div></div><h3 id="builtin"><a href="#builtin" class="anchor"></a>Built-in middleware</h3><p>Built-in middleware is Dream functionality that is implemented as middleware for maintainability reasons. It is necessary for Dream to work correctly. However, because it is middleware, Dream allows replacing it with <a href="#val-run"><code>Dream.run</code></a> <code>~builtins:false</code>. The middleware is applied in documented order, so</p><pre><code>Dream.run my_app</code></pre><p>is the same as</p><pre><code>Dream.run ~builtins:false
@@ Dream.lowercase_headers
@@ Dream.content_length
@@ Dream.catch (* ... *)
@@ Dream.assign_request_id
@@ Dream.chop_site_prefix
@@ my_app</code></pre><p>The middleware can be replaced with work-alikes, or omitted to use Dream as a fairly raw abstraction layer over low-level HTTP libraries.</p><div class="odoc-spec"><div class="spec value" id="val-lowercase_headers" class="anchored"><a href="#val-lowercase_headers" class="anchor"></a><code><span><span class="keyword">val</span> lowercase_headers : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Lowercases response headers for HTTP/2 requests.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-content_length" class="anchored"><a href="#val-content_length" class="anchor"></a><code><span><span class="keyword">val</span> content_length : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>If the request has <a href="#val-version"><code>Dream.version</code></a> <code>(1, _)</code>, then...</p><ul><li>if the response does not have <code>Content-Length:</code> and the body is a string, sets <code>Content-Length:</code> to the string's length, or</li><li>if the response does not have <code>Transfer-Encoding:</code> and the body is a stream, sets <code>Transfer-Encoding: chunked</code>.</li></ul><p>This is built in because an application cannot be expected to decide including these headers in the face of transparent HTTP/2 upgrades. The headers are necessary in HTTP/1, and forbidden or redundant and difficult to use in HTTP/2.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-catch" class="anchored"><a href="#val-catch" class="anchor"></a><code><span><span class="keyword">val</span> catch : <span><span>(<span><a href="#type-error">error</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response">response</a> <a href="#type-promise">promise</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Forwards exceptions, rejections, and <code>4xx</code>, <code>5xx</code> responses from the application to the error handler. See <a href="#errors">Errors</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-assign_request_id" class="anchored"><a href="#val-assign_request_id" class="anchor"></a><code><span><span class="keyword">val</span> assign_request_id : <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Assigns an id to each request.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-chop_site_prefix" class="anchored"><a href="#val-chop_site_prefix" class="anchor"></a><code><span><span class="keyword">val</span> chop_site_prefix : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-middleware">middleware</a></span></code></div><div class="spec-doc"><p>Removes <a href="#val-run"><code>Dream.run</code></a> <code>~prefix</code> from the path in each request, and adds it to the request prefix. Responds with <code>502 Bad Gateway</code> if the path does not have the expected prefix.</p></div></div><h2 id="web_formats"><a href="#web_formats" class="anchor"></a>Web formats</h2><div class="odoc-spec"><div class="spec value" id="val-html_escape" class="anchored"><a href="#val-html_escape" class="anchor"></a><code><span><span class="keyword">val</span> html_escape : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Escapes a string so that it is suitable for use as text inside HTML elements and quoted attribute values. Implements <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html#rule-1-html-encode-before-inserting-untrusted-data-into-html-element-content">OWASP <i>Cross-Site Scripting Prevention Cheat Sheet RULE #1</i></a>.</p><p>This function is <em>not</em> suitable for use with unquoted attributes, inline scripts, or inline CSS. See <i>Security</i> in example <a href="https://github.com/aantron/dream/tree/master/example/7-template#security"><code>7-template</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-to_base64url" class="anchored"><a href="#val-to_base64url" class="anchor"></a><code><span><span class="keyword">val</span> to_base64url : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Converts the given string its base64url encoding, as specified in <a href="https://tools.ietf.org/html/rfc4648#section-5">RFC 4648 §5</a>, using a Web-safe alphabet and no padding. The resulting string can be used without escaping in URLs, form data, cookies, HTML content, attributes, and JavaScript code. For more options, see the <a href="https://mirage.github.io/ocaml-base64/base64/Base64/index.html">Base64</a> library.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_base64url" class="anchored"><a href="#val-from_base64url" class="anchor"></a><code><span><span class="keyword">val</span> from_base64url : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>Inverse of <a href="#val-to_base64url"><code>Dream.to_base64url</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-to_percent_encoded" class="anchored"><a href="#val-to_percent_encoded" class="anchor"></a><code><span><span class="keyword">val</span> to_percent_encoded : <span>?international:bool <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Percent-encodes a string for use inside a URL.</p><p><code>~international</code> is <code>true</code> by default, and causes non-ASCII bytes to be preserved. This is suitable for display to users, including in <code>&lt;a href=&quot;&quot;&gt;</code> attributes, which are displayed in browser status lines. See <a href="https://tools.ietf.org/html/rfc3987">RFC 3987</a>.</p><p>Use <code>~international:false</code> for compatibility with legacy systems, or when constructing URL fragments from untrusted input that may not match the interface language(s) the user expects. In the latter case, similar letters from different writing scripts can be used to mislead users about the targets of links.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_percent_encoded" class="anchored"><a href="#val-from_percent_encoded" class="anchor"></a><code><span><span class="keyword">val</span> from_percent_encoded : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Inverse of <a href="#val-to_percent_encoded"><code>Dream.to_percent_encoded</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-to_form_urlencoded" class="anchored"><a href="#val-to_form_urlencoded" class="anchor"></a><code><span><span class="keyword">val</span> to_form_urlencoded : <span><span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Inverse of <a href="#val-from_form_urlencoded"><code>Dream.from_form_urlencoded</code></a>. Percent-encodes names and values.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_form_urlencoded" class="anchored"><a href="#val-from_form_urlencoded" class="anchor"></a><code><span><span class="keyword">val</span> from_form_urlencoded : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Converts form data or a query string from <code>application/x-www-form-urlencoded</code> format to a list of name-value pairs. See <a href="https://tools.ietf.org/html/rfc1866#section-8.2.1">RFC 1866 §8.2.1</a>. Reverses the percent-encoding of names and values.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_cookie" class="anchored"><a href="#val-from_cookie" class="anchor"></a><code><span><span class="keyword">val</span> from_cookie : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Converts a <code>Cookie:</code> header value to key-value pairs. See <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-4.2.1">RFC 6265bis §4.2.1</a>. Does not apply any decoding to names and values.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-to_set_cookie" class="anchored"><a href="#val-to_set_cookie" class="anchor"></a><code><span><span class="keyword">val</span> to_set_cookie : <span>?expires:float <span class="arrow">&#45;&gt;</span></span> <span>?max_age:float <span class="arrow">&#45;&gt;</span></span> <span>?domain:string <span class="arrow">&#45;&gt;</span></span>
<span>?path:string <span class="arrow">&#45;&gt;</span></span> <span>?secure:bool <span class="arrow">&#45;&gt;</span></span> <span>?http_only:bool <span class="arrow">&#45;&gt;</span></span>
<span>?same_site:<span>[ `Strict <span>| `Lax</span> <span>| `None</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>Dream.to_set_cookie name value</code> formats a <code>Set-Cookie:</code> header value. The optional arguments correspond to the attributes specified in <a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-07#section-5.3">RFC 6265bis §5.3</a>, and are documented at <a href="#val-set_cookie"><code>Dream.set_cookie</code></a>.</p><p>Does not apply any encoding to names and values. Be sure to encode so that names and values cannot contain `=`, `;`, or newline characters.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-split_target" class="anchored"><a href="#val-split_target" class="anchor"></a><code><span><span class="keyword">val</span> split_target : <span>string <span class="arrow">&#45;&gt;</span></span> string * string</span></code></div><div class="spec-doc"><p>Splits a request target into a path and a query string.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-from_path" class="anchored"><a href="#val-from_path" class="anchor"></a><code><span><span class="keyword">val</span> from_path : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>Splits the string into components on <code>/</code> and percent-decodes each component. Empty components are dropped, except for the last. This function does not distinguish between absolute and relative paths, and is only meant for routes and request targets. So,</p><ul><li><code>Dream.from_path &quot;&quot;</code> becomes <code>[]</code>.</li><li><code>Dream.from_path &quot;/&quot;</code> becomes <code>[&quot;&quot;]</code>.</li><li><code>Dream.from_path &quot;abc&quot;</code> becomes <code>[&quot;abc&quot;]</code>.</li><li><code>Dream.from_path &quot;/abc&quot;</code> becomes <code>[&quot;abc&quot;]</code>.</li><li><code>Dream.from_path &quot;abc/&quot;</code> becomes <code>[&quot;abc&quot;; &quot;&quot;]</code>.</li><li><code>Dream.from_path &quot;a%2Fb&quot;</code> becomes <code>[&quot;a/b&quot;]</code>.</li><li><code>Dream.from_path &quot;a//b&quot;</code> becomes <code>[&quot;a&quot;; &quot;b&quot;]</code>.</li></ul><p>This function is not for use on full targets, because they may incldue query strings (<code>?</code>), and <a href="#val-from_path"><code>Dream.from_path</code></a> does not treat them specially. Split query strings off with <a href="#val-split_target"><code>Dream.split_target</code></a> first.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-to_path" class="anchored"><a href="#val-to_path" class="anchor"></a><code><span><span class="keyword">val</span> to_path : <span>?relative:bool <span class="arrow">&#45;&gt;</span></span> <span>?international:bool <span class="arrow">&#45;&gt;</span></span> <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Percent-encodes a list of path components and joins them with <code>/</code> into a path. Empty components, except for the last, are removed. The path is absolute by default. Use <code>~relative:true</code> for a relative path. <a href="#val-to_path"><code>Dream.to_path</code></a> uses an IRI-friendly percent encoder, which preserves UTF-8 bytes in unencoded form. Use <code>~international:false</code> to percent-encode those bytes as well, for legacy protocols that require ASCII URLs.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-drop_trailing_slash" class="anchored"><a href="#val-drop_trailing_slash" class="anchor"></a><code><span><span class="keyword">val</span> drop_trailing_slash : <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>Changes the representation of path <code>abc/</code> to the representation of <code>abc</code> by checking if the last element in the list is <code>&quot;&quot;</code>, and, if it is, dropping it.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-text_html" class="anchored"><a href="#val-text_html" class="anchor"></a><code><span><span class="keyword">val</span> text_html : string</span></code></div><div class="spec-doc"><p>The string <code>&quot;text/html; charset=utf-8&quot;</code> for <code>Content-Type:</code> headers.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-application_json" class="anchored"><a href="#val-application_json" class="anchor"></a><code><span><span class="keyword">val</span> application_json : string</span></code></div><div class="spec-doc"><p>The string <code>&quot;application/json&quot;</code> for <code>Content-Type:</code> headers.</p></div></div><h2 id="cryptography"><a href="#cryptography" class="anchor"></a>Cryptography</h2><div class="odoc-spec"><div class="spec value" id="val-random" class="anchored"><a href="#val-random" class="anchor"></a><code><span><span class="keyword">val</span> random : <span>int <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Generates the requested number of bytes using a <a href="https://github.com/mirage/mirage-crypto">cryptographically secure random number generator</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-encrypt" class="anchored"><a href="#val-encrypt" class="anchor"></a><code><span><span class="keyword">val</span> encrypt : <span>?associated_data:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Signs and encrypts the string using the <code>~secret</code> in the request. See <a href="#val-run"><code>Dream.run</code></a> for setting <code>~secret</code>.</p><p><code>~associated_data</code> is included when computing the signature, but not included in the ciphertext. It can be used like a “salt,” to force ciphertexts from different contexts to be distinct, and dependent on the context.</p><p>For example, when <a href="#val-set_cookie"><code>Dream.set_cookie</code></a> encrypts cookie values, it internally passes the cookie names in the associated data. This makes it impossible (or impractical) to use the ciphertext from one cookie as the value of another. The associated data will not match, and the value will be recognized as invalid.</p><p>The cipher presently used by Dream is <a href="https://tools.ietf.org/html/rfc5116#section-5.2">AEAD_AES_256_GCM</a>. It will be replaced by <a href="https://tools.ietf.org/html/rfc8452">AEAD_AES_256_GCM_SIV</a> as soon as the latter is <a href="https://github.com/mirage/mirage-crypto/issues/111">available</a>. The upgrade will be transparent, because Dream includes a cipher rotation scheme.</p><p>The cipher is suitable for encrypted transmissions and storing data other than credentials. For password or other credential storage, see package <a href="https://github.com/Khady/ocaml-argon2"><code>argon2</code></a>. See <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html">OWASP <i>Cryptographic Storage Cheat Sheet</i></a> and <a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html">OWASP <i>Password Storage Cheat Sheet</i></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-decrypt" class="anchored"><a href="#val-decrypt" class="anchor"></a><code><span><span class="keyword">val</span> decrypt : <span>?associated_data:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p>Reverses <a href="#val-encrypt"><code>Dream.encrypt</code></a>.</p><p>To support secret rotation, the decryption secrets with which decryption is attempted are <code>(~secret)::(~old_secrets)</code>. See the descriptions of <code>~secret</code> and <code>~old_secrets</code> in <a href="#val-run"><code>Dream.run</code></a>.</p></div></div><h2 id="variables"><a href="#variables" class="anchor"></a>Variables</h2><p>Dream provides two variable scopes for use by middlewares.</p><div class="odoc-spec"><div class="spec type" id="type-local" class="anchored"><a href="#type-local" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a local</span></span></code></div><div class="spec-doc"><p>Per-message variable.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-global" class="anchored"><a href="#type-global" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a global</span></span></code></div><div class="spec-doc"><p>Per-server variable.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-new_local" class="anchored"><a href="#val-new_local" class="anchor"></a><code><span><span class="keyword">val</span> new_local : <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?show_value:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-local">local</a></span></span></code></div><div class="spec-doc"><p>Declares a variable of type <code>'a</code> in all messages. The variable is initially unset in each message. The optional <code>~name</code> and <code>~show_value</code> are used by <a href="#val-run"><code>Dream.run</code></a> <code>~debug</code> to show the variable in debug dumps.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-local" class="anchored"><a href="#val-local" class="anchor"></a><code><span><span class="keyword">val</span> local : <span><span><span class="type-var">'a</span> <a href="#type-local">local</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p>Retrieves the value of the per-message variable.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_local" class="anchored"><a href="#val-with_local" class="anchor"></a><code><span><span class="keyword">val</span> with_local : <span><span><span class="type-var">'a</span> <a href="#type-local">local</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p>Sets the per-message variable to the value.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-new_global" class="anchored"><a href="#val-new_global" class="anchor"></a><code><span><span class="keyword">val</span> new_global : <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?show_value:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-global">global</a></span></span></code></div><div class="spec-doc"><p>Declares a variable of type <code>'a</code> in all servers. The first time the variable is accessed, the given initializer function is called to get its value. Global variables cannot be changed. So, they are typically refs or other mutable data structures, such as hash tables.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-global" class="anchored"><a href="#val-global" class="anchor"></a><code><span><span class="keyword">val</span> global : <span><span><span class="type-var">'a</span> <a href="#type-global">global</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Retrieves the value of the per-server variable.</p></div></div><h2 id="testing"><a href="#testing" class="anchor"></a>Testing</h2><div class="odoc-spec"><div class="spec value" id="val-request" class="anchored"><a href="#val-request" class="anchor"></a><code><span><span class="keyword">val</span> request : <span>?client:string <span class="arrow">&#45;&gt;</span></span> <span>?method_:<a href="#type-method_">method_</a> <span class="arrow">&#45;&gt;</span></span> <span>?target:string <span class="arrow">&#45;&gt;</span></span> <span>?version:<span>(int * int)</span>
<span class="arrow">&#45;&gt;</span></span> <span>?headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-request">request</a></span></code></div><div class="spec-doc"><p><code>Dream.request body</code> creates a fresh request with the given body for testing. The optional arguments set the corresponding <a href="#requests">request fields</a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-test" class="anchored"><a href="#val-test" class="anchor"></a><code><span><span class="keyword">val</span> test : <span>?prefix:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-request">request</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-response">response</a></span></code></div><div class="spec-doc"><p><code>Dream.test handler</code> runs a handler the same way the HTTP server (<a href="#val-run"><code>Dream.run</code></a>) would — assigning it a request id and noting the site root prefix, which is used by routers. <code>Dream.test</code> calls <a href="https://ocsigen.org/lwt/latest/api/Lwt_main#VALrun"><code>Lwt_main.run</code></a> internally to await the response, which is why the response returned from the test is not wrapped in a promise. If you don't need these facilities, you can test <code>handler</code> by calling it directly with a request.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-first" class="anchored"><a href="#val-first" class="anchor"></a><code><span><span class="keyword">val</span> first : <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p><code>Dream.first message</code> evaluates to the original request or response that <code>message</code> is immutably derived from. This is useful for getting the original state of requests especially, when they were first created inside the HTTP server (<a href="#val-run"><code>Dream.run</code></a>).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-last" class="anchored"><a href="#val-last" class="anchor"></a><code><span><span class="keyword">val</span> last : <span><span><span class="type-var">'a</span> <a href="#type-message">message</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-message">message</a></span></span></code></div><div class="spec-doc"><p><code>Dream.last message</code> evaluates to the latest request or response that was derived from <code>message</code>. This is most useful for obtaining the state of requests at the time an exception was raised, without having to instrument the latest version of the request before the exception.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-sort_headers" class="anchored"><a href="#val-sort_headers" class="anchor"></a><code><span><span class="keyword">val</span> sort_headers : <span><span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Sorts headers by name. Headers with the same name are not sorted by value or otherwise reordered, because order is significant for some headers. See <a href="https://tools.ietf.org/html/rfc7230#section-3.2.2">RFC 7230 §3.2.2</a> on header order. This function can help sanitize output before comparison.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-echo" class="anchored"><a href="#val-echo" class="anchor"></a><code><span><span class="keyword">val</span> echo : <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Responds with the request body.</p></div></div></div>